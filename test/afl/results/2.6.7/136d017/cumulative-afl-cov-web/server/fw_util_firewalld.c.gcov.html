<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - id:002084,src:002034,op:havoc,rep:2.lcov_info_final - server/fw_util_firewalld.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">server</a> - fw_util_firewalld.c<span style="font-size: 80%;"> (source / <a href="fw_util_firewalld.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">id:002084,src:002034,op:havoc,rep:2.lcov_info_final</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">53</td>
            <td class="headerCovTableEntry">575</td>
            <td class="headerCovTableEntryLo">9.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2015-05-25</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntry">29</td>
            <td class="headerCovTableEntryLo">10.3 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">34</td>
            <td class="headerCovTableEntry">302</td>
            <td class="headerCovTableEntryLo">11.3 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  *****************************************************************************
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * File:    fw_util_firewalld.c
<span class="lineNum">       5 </span>                :            :  *
<span class="lineNum">       6 </span>                :            :  * Purpose: Fwknop routines for managing firewalld firewall rules.
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  *  Fwknop is developed primarily by the people listed in the file 'AUTHORS'.
<span class="lineNum">       9 </span>                :            :  *  Copyright (C) 2009-2014 fwknop developers and contributors. For a full
<span class="lineNum">      10 </span>                :            :  *  list of contributors, see the file 'CREDITS'.
<span class="lineNum">      11 </span>                :            :  *
<span class="lineNum">      12 </span>                :            :  *  License (GNU General Public License):
<span class="lineNum">      13 </span>                :            :  *
<span class="lineNum">      14 </span>                :            :  *  This program is free software; you can redistribute it and/or
<span class="lineNum">      15 </span>                :            :  *  modify it under the terms of the GNU General Public License
<span class="lineNum">      16 </span>                :            :  *  as published by the Free Software Foundation; either version 2
<span class="lineNum">      17 </span>                :            :  *  of the License, or (at your option) any later version.
<span class="lineNum">      18 </span>                :            :  *
<span class="lineNum">      19 </span>                :            :  *  This program is distributed in the hope that it will be useful,
<span class="lineNum">      20 </span>                :            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      21 </span>                :            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      22 </span>                :            :  *  GNU General Public License for more details.
<span class="lineNum">      23 </span>                :            :  *
<span class="lineNum">      24 </span>                :            :  *  You should have received a copy of the GNU General Public License
<span class="lineNum">      25 </span>                :            :  *  along with this program; if not, write to the Free Software
<span class="lineNum">      26 </span>                :            :  *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307
<span class="lineNum">      27 </span>                :            :  *  USA
<span class="lineNum">      28 </span>                :            :  *
<span class="lineNum">      29 </span>                :            :  *****************************************************************************
<span class="lineNum">      30 </span>                :            : */
<span class="lineNum">      31 </span>                :            : 
<span class="lineNum">      32 </span>                :            : #include &quot;fwknopd_common.h&quot;
<span class="lineNum">      33 </span>                :            : 
<span class="lineNum">      34 </span>                :            : #ifdef FIREWALL_FIREWALLD
<span class="lineNum">      35 </span>                :            : 
<span class="lineNum">      36 </span>                :            : #include &quot;fw_util.h&quot;
<span class="lineNum">      37 </span>                :            : #include &quot;utils.h&quot;
<span class="lineNum">      38 </span>                :            : #include &quot;log_msg.h&quot;
<span class="lineNum">      39 </span>                :            : #include &quot;extcmd.h&quot;
<span class="lineNum">      40 </span>                :            : #include &quot;access.h&quot;
<span class="lineNum">      41 </span>                :            : 
<span class="lineNum">      42 </span>                :            : static struct fw_config fwc;
<span class="lineNum">      43 </span>                :            : static char   cmd_buf[CMD_BUFSIZE];
<span class="lineNum">      44 </span>                :            : static char   err_buf[CMD_BUFSIZE];
<span class="lineNum">      45 </span>                :            : static char   cmd_out[STANDARD_CMD_OUT_BUFSIZE];
<span class="lineNum">      46 </span>                :            : 
<span class="lineNum">      47 </span>                :            : /* assume 'firewall-cmd --direct --passthrough ipv4 -C' is offered
<span class="lineNum">      48 </span>                :            :  * (see firewd_chk_support()).
<span class="lineNum">      49 </span>                :            : */
<span class="lineNum">      50 </span>                :            : static int have_firewd_chk_support = 1;
<a name="51"><span class="lineNum">      51 </span>                :            : </a>
<span class="lineNum">      52 </span>                :            : static void
<span class="lineNum">      53 </span>                :<span class="lineNoCov">          0 : zero_cmd_buffers(void)</span>
<span class="lineNum">      54 </span>                :            : {
<span class="lineNum">      55 </span>                :            :     memset(cmd_buf, 0x0, CMD_BUFSIZE);
<span class="lineNum">      56 </span>                :            :     memset(err_buf, 0x0, CMD_BUFSIZE);
<span class="lineNum">      57 </span>                :            :     memset(cmd_out, 0x0, STANDARD_CMD_OUT_BUFSIZE);
<span class="lineNum">      58 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">      59 </span>                :            : 
<span class="lineNum">      60 </span>                :            : static int pid_status = 0;
<a name="61"><span class="lineNum">      61 </span>                :            : </a>
<span class="lineNum">      62 </span>                :            : static void
<span class="lineNum">      63 </span>                :<span class="lineNoCov">          0 : chop_newline(char *str)</span>
<span class="lineNum">      64 </span>                :            : {
<span class="lineNum">      65 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(str[0] != 0x0 &amp;&amp; str[strlen(str)-1] == 0x0a)</span>
<span class="lineNum">      66 </span>                :<span class="lineNoCov">          0 :         str[strlen(str)-1] = 0x0;</span>
<span class="lineNum">      67 </span>                :<span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">      68 </span>                :            : }
<a name="69"><span class="lineNum">      69 </span>                :            : </a>
<span class="lineNum">      70 </span>                :            : static int
<span class="lineNum">      71 </span>                :<span class="lineNoCov">          0 : rule_exists_no_chk_support(const fko_srv_options_t * const opts,</span>
<span class="lineNum">      72 </span>                :            :         const struct fw_chain * const fwc, const unsigned int proto,
<span class="lineNum">      73 </span>                :            :         const char * const srcip, const char * const dstip, 
<span class="lineNum">      74 </span>                :            :         const unsigned int port, const unsigned int exp_ts)
<span class="lineNum">      75 </span>                :            : {
<span class="lineNum">      76 </span>                :<span class="lineNoCov">          0 :     int     rule_exists=0;</span>
<span class="lineNum">      77 </span>                :<span class="lineNoCov">          0 :     char    cmd_buf[CMD_BUFSIZE]       = {0};</span>
<span class="lineNum">      78 </span>                :<span class="lineNoCov">          0 :     char    target_search[CMD_BUFSIZE] = {0};</span>
<span class="lineNum">      79 </span>                :<span class="lineNoCov">          0 :     char    proto_search[CMD_BUFSIZE]  = {0};</span>
<span class="lineNum">      80 </span>                :<span class="lineNoCov">          0 :     char    srcip_search[CMD_BUFSIZE]  = {0};</span>
<span class="lineNum">      81 </span>                :<span class="lineNoCov">          0 :     char    dstip_search[CMD_BUFSIZE]  = {0};</span>
<span class="lineNum">      82 </span>                :<span class="lineNoCov">          0 :     char    port_search[CMD_BUFSIZE]   = {0};</span>
<span class="lineNum">      83 </span>                :<span class="lineNoCov">          0 :     char    exp_ts_search[CMD_BUFSIZE] = {0};</span>
<span class="lineNum">      84 </span>                :            : 
<span class="lineNum">      85 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_LIST_RULES_ARGS,
<span class="lineNum">      86 </span>                :<span class="lineNoCov">          0 :         opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">      87 </span>                :<span class="lineNoCov">          0 :         fwc-&gt;table,</span>
<span class="lineNum">      88 </span>                :<span class="lineNoCov">          0 :         fwc-&gt;to_chain</span>
<span class="lineNum">      89 </span>                :            :     );
<span class="lineNum">      90 </span>                :            : 
<span class="lineNum">      91 </span>                :            : #if CODE_COVERAGE
<span class="lineNum">      92 </span>                :<span class="lineNoCov">          0 :     int pid_status = 0;</span>
<span class="lineNum">      93 </span>                :            :     /* If we're maximizing code coverage, then exercise the run_extcmd_write()
<span class="lineNum">      94 </span>                :            :      * function which is normally only used for the PF firewall. This is to
<span class="lineNum">      95 </span>                :            :      * maximize code coverage in conjunction with the test suite, and is never
<span class="lineNum">      96 </span>                :            :      * compiled in for a production release of fwknop.
<span class="lineNum">      97 </span>                :            :     */
<span class="lineNum">      98 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(run_extcmd_write(&quot;/bin/grep -v test&quot;, &quot;/bin/echo test&quot;, &amp;pid_status, opts) == 0)</span>
<span class="lineNum">      99 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_WARNING, &quot;[ignore] Code coverage: Executed command&quot;);</span>
<span class="lineNum">     100 </span>                :            : #endif
<span class="lineNum">     101 </span>                :            : 
<span class="lineNum">     102 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(proto == IPPROTO_TCP)</span>
<span class="lineNum">     103 </span>                :            :         snprintf(proto_search, CMD_BUFSIZE-1, &quot; tcp &quot;);
<span class="lineNum">     104 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     else if(proto == IPPROTO_UDP)</span>
<span class="lineNum">     105 </span>                :            :         snprintf(proto_search, CMD_BUFSIZE-1, &quot; udp &quot;);
<span class="lineNum">     106 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     else if(proto == IPPROTO_ICMP)</span>
<span class="lineNum">     107 </span>                :            :         snprintf(proto_search, CMD_BUFSIZE-1, &quot; icmp &quot;);
<span class="lineNum">     108 </span>                :            :     else
<span class="lineNum">     109 </span>                :            :         snprintf(proto_search, CMD_BUFSIZE-1, &quot; %u &quot;, proto);
<span class="lineNum">     110 </span>                :            : 
<span class="lineNum">     111 </span>                :            :     snprintf(port_search, CMD_BUFSIZE-1, &quot;:%u &quot;, port);
<span class="lineNum">     112 </span>                :<span class="lineNoCov">          0 :     snprintf(target_search, CMD_BUFSIZE-1, &quot; %s &quot;, fwc-&gt;target);</span>
<span class="lineNum">     113 </span>                :            :     snprintf(srcip_search, CMD_BUFSIZE-1, &quot; %s &quot;, srcip);
<span class="lineNum">     114 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (dstip != NULL)</span>
<span class="lineNum">     115 </span>                :            :     {
<span class="lineNum">     116 </span>                :            :         snprintf(dstip_search, CMD_BUFSIZE-1, &quot; %s &quot;, dstip);
<span class="lineNum">     117 </span>                :            :     }
<span class="lineNum">     118 </span>                :            :     snprintf(exp_ts_search, CMD_BUFSIZE-1, &quot;%u &quot;, exp_ts);
<span class="lineNum">     119 </span>                :            : 
<span class="lineNum">     120 </span>                :            :     /* search for each of the substrings - yes, matches from different
<span class="lineNum">     121 </span>                :            :      * rules may get triggered here, but the expiration time is the
<span class="lineNum">     122 </span>                :            :      * primary search method
<span class="lineNum">     123 </span>                :            :     */
<span class="lineNum">     124 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(search_extcmd(cmd_buf, WANT_STDERR, NO_TIMEOUT, exp_ts_search, &amp;pid_status, opts)</span>
<span class="lineNum">     125 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             &amp;&amp; search_extcmd(cmd_buf, WANT_STDERR, NO_TIMEOUT, proto_search, &amp;pid_status, opts)</span>
<span class="lineNum">     126 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             &amp;&amp; search_extcmd(cmd_buf, WANT_STDERR, NO_TIMEOUT, srcip_search, &amp;pid_status, opts)</span>
<span class="lineNum">     127 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             &amp;&amp; (dstip == NULL) ? 1 : search_extcmd(cmd_buf, WANT_STDERR, NO_TIMEOUT, dstip_search, &amp;pid_status, opts)</span>
<span class="lineNum">     128 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             &amp;&amp; search_extcmd(cmd_buf, WANT_STDERR, NO_TIMEOUT, target_search, &amp;pid_status, opts)</span>
<span class="lineNum">     129 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             &amp;&amp; search_extcmd(cmd_buf, WANT_STDERR, NO_TIMEOUT, port_search, &amp;pid_status, opts))</span>
<span class="lineNum">     130 </span>                :            :         rule_exists = 1;
<span class="lineNum">     131 </span>                :            : 
<span class="lineNum">     132 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(rule_exists)</span>
<span class="lineNum">     133 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG,</span>
<span class="lineNum">     134 </span>                :            :                 &quot;rule_exists_no_chk_support() %s %u -&gt; %s expires: %u rule (already exists&quot;,
<span class="lineNum">     135 </span>                :            :                 proto_search, port, srcip, exp_ts);
<span class="lineNum">     136 </span>                :            :     else
<span class="lineNum">     137 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG,</span>
<span class="lineNum">     138 </span>                :            :                 &quot;rule_exists_no_chk_support() %s %u -&gt; %s expires: %u rule does not exist&quot;,
<span class="lineNum">     139 </span>                :            :                 proto_search, port, srcip, exp_ts);
<span class="lineNum">     140 </span>                :            : 
<span class="lineNum">     141 </span>                :<span class="lineNoCov">          0 :    return(rule_exists);</span>
<span class="lineNum">     142 </span>                :            : }
<a name="143"><span class="lineNum">     143 </span>                :            : </a>
<span class="lineNum">     144 </span>                :            : static int
<span class="lineNum">     145 </span>                :<span class="lineNoCov">          0 : rule_exists_chk_support(const fko_srv_options_t * const opts,</span>
<span class="lineNum">     146 </span>                :            :         const char * const chain, const char * const rule)
<span class="lineNum">     147 </span>                :            : {
<span class="lineNum">     148 </span>                :<span class="lineNoCov">          0 :     int     rule_exists = 0;</span>
<span class="lineNum">     149 </span>                :<span class="lineNoCov">          0 :     int     res = 0;</span>
<span class="lineNum">     150 </span>                :            : 
<span class="lineNum">     151 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     152 </span>                :            : 
<span class="lineNum">     153 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_CHK_RULE_ARGS,
<span class="lineNum">     154 </span>                :<span class="lineNoCov">          0 :             opts-&gt;fw_config-&gt;fw_command, chain, rule);</span>
<span class="lineNum">     155 </span>                :            : 
<span class="lineNum">     156 </span>                :<span class="lineNoCov">          0 :     res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">     157 </span>                :            :             WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     158 </span>                :<span class="lineNoCov">          0 :     chop_newline(err_buf);</span>
<span class="lineNum">     159 </span>                :            : 
<span class="lineNum">     160 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG, &quot;rule_exists_chk_support() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     161 </span>                :            :         cmd_buf, res, err_buf);
<span class="lineNum">     162 </span>                :            : 
<span class="lineNum">     163 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(strncmp(err_buf, &quot;success&quot;, strlen(&quot;success&quot;)) == 0)</span>
<span class="lineNum">     164 </span>                :            :     {
<span class="lineNum">     165 </span>                :<span class="lineNoCov">          0 :         rule_exists = 1;</span>
<span class="lineNum">     166 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;rule_exists_chk_support() Rule : '%s' in %s already exists&quot;,</span>
<span class="lineNum">     167 </span>                :            :                 rule, chain);
<span class="lineNum">     168 </span>                :            :     }
<span class="lineNum">     169 </span>                :            :     else
<span class="lineNum">     170 </span>                :            :     {
<span class="lineNum">     171 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;rule_exists_chk_support() Rule : '%s' in %s does not exist&quot;,</span>
<span class="lineNum">     172 </span>                :            :                 rule, chain);
<span class="lineNum">     173 </span>                :            :     }
<span class="lineNum">     174 </span>                :            : 
<span class="lineNum">     175 </span>                :<span class="lineNoCov">          0 :     return(rule_exists);</span>
<span class="lineNum">     176 </span>                :            : }
<a name="177"><span class="lineNum">     177 </span>                :            : </a>
<span class="lineNum">     178 </span>                :            : static int
<span class="lineNum">     179 </span>                :<span class="lineNoCov">          0 : rule_exists(const fko_srv_options_t * const opts,</span>
<span class="lineNum">     180 </span>                :            :         const struct fw_chain * const fwc, const char * const rule,
<span class="lineNum">     181 </span>                :            :         const unsigned int proto, const char * const srcip,
<span class="lineNum">     182 </span>                :            :         const char * const dstip, const unsigned int port, 
<span class="lineNum">     183 </span>                :            :         const unsigned int exp_ts)
<span class="lineNum">     184 </span>                :            : {
<span class="lineNum">     185 </span>                :<span class="lineNoCov">          0 :     int rule_exists = 0;</span>
<span class="lineNum">     186 </span>                :            : 
<span class="lineNum">     187 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(have_firewd_chk_support == 1)</span>
<span class="lineNum">     188 </span>                :<span class="lineNoCov">          0 :         rule_exists = rule_exists_chk_support(opts, fwc-&gt;to_chain, rule);</span>
<span class="lineNum">     189 </span>                :            :     else
<span class="lineNum">     190 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         rule_exists = rule_exists_no_chk_support(opts, fwc, proto, srcip, (opts-&gt;fw_config-&gt;use_destination ? dstip : NULL), port, exp_ts);</span>
<span class="lineNum">     191 </span>                :            : 
<span class="lineNum">     192 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(rule_exists == 1)</span>
<span class="lineNum">     193 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;rule_exists() Rule : '%s' in %s already exists&quot;,</span>
<span class="lineNum">     194 </span>                :<span class="lineNoCov">          0 :                 rule, fwc-&gt;to_chain);</span>
<span class="lineNum">     195 </span>                :            :     else
<span class="lineNum">     196 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;rule_exists() Rule : '%s' in %s does not exist&quot;,</span>
<span class="lineNum">     197 </span>                :<span class="lineNoCov">          0 :                 rule, fwc-&gt;to_chain);</span>
<span class="lineNum">     198 </span>                :            : 
<span class="lineNum">     199 </span>                :<span class="lineNoCov">          0 :     return(rule_exists);</span>
<span class="lineNum">     200 </span>                :            : }
<a name="201"><span class="lineNum">     201 </span>                :            : </a>
<span class="lineNum">     202 </span>                :            : static void
<span class="lineNum">     203 </span>                :<span class="lineNoCov">          0 : firewd_chk_support(const fko_srv_options_t * const opts)</span>
<span class="lineNum">     204 </span>                :            : {
<span class="lineNum">     205 </span>                :<span class="lineNoCov">          0 :     int               res = 1;</span>
<span class="lineNum">     206 </span>                :<span class="lineNoCov">          0 :     struct fw_chain  *in_chain = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_INPUT_ACCESS]);</span>
<span class="lineNum">     207 </span>                :            : 
<span class="lineNum">     208 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     209 </span>                :            : 
<span class="lineNum">     210 </span>                :            :     /* Add a harmless rule to the firewalld INPUT chain and see if firewalld
<span class="lineNum">     211 </span>                :            :      * supports '-C' to check for it.  Set &quot;have_firewd_chk_support&quot; accordingly,
<span class="lineNum">     212 </span>                :            :      * delete the rule, and return.
<span class="lineNum">     213 </span>                :            :     */
<span class="lineNum">     214 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_TMP_CHK_RULE_ARGS,
<span class="lineNum">     215 </span>                :<span class="lineNoCov">          0 :         opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">     216 </span>                :<span class="lineNoCov">          0 :         in_chain-&gt;table,</span>
<span class="lineNum">     217 </span>                :<span class="lineNoCov">          0 :         in_chain-&gt;from_chain,</span>
<span class="lineNum">     218 </span>                :            :         1,   /* first rule */
<span class="lineNum">     219 </span>                :<span class="lineNoCov">          0 :         in_chain-&gt;target</span>
<span class="lineNum">     220 </span>                :            :     );
<span class="lineNum">     221 </span>                :            : 
<span class="lineNum">     222 </span>                :<span class="lineNoCov">          0 :     res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">     223 </span>                :            :             WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     224 </span>                :<span class="lineNoCov">          0 :     chop_newline(err_buf);</span>
<span class="lineNum">     225 </span>                :            : 
<span class="lineNum">     226 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG, &quot;firewd_chk_support() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     227 </span>                :            :         cmd_buf, res, err_buf);
<span class="lineNum">     228 </span>                :            : 
<span class="lineNum">     229 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     230 </span>                :            : 
<span class="lineNum">     231 </span>                :            :     /* Now see if '-C' works
<span class="lineNum">     232 </span>                :            :     */
<span class="lineNum">     233 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_TMP_VERIFY_CHK_ARGS,
<span class="lineNum">     234 </span>                :<span class="lineNoCov">          0 :         opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">     235 </span>                :            :         in_chain-&gt;table,
<span class="lineNum">     236 </span>                :            :         in_chain-&gt;from_chain,
<span class="lineNum">     237 </span>                :            :         in_chain-&gt;target
<span class="lineNum">     238 </span>                :            :     );
<span class="lineNum">     239 </span>                :            : 
<span class="lineNum">     240 </span>                :<span class="lineNoCov">          0 :     res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">     241 </span>                :            :             WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     242 </span>                :<span class="lineNoCov">          0 :     chop_newline(err_buf);</span>
<span class="lineNum">     243 </span>                :            : 
<span class="lineNum">     244 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG, &quot;firewd_chk_support() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     245 </span>                :            :         cmd_buf, res, err_buf);
<span class="lineNum">     246 </span>                :            : 
<span class="lineNum">     247 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(strncmp(err_buf, &quot;success&quot;, strlen(&quot;success&quot;)) == 0)</span>
<span class="lineNum">     248 </span>                :            :     {
<span class="lineNum">     249 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;firewd_chk_support() -C supported&quot;);</span>
<span class="lineNum">     250 </span>                :<span class="lineNoCov">          0 :         have_firewd_chk_support = 1;</span>
<span class="lineNum">     251 </span>                :            :     }
<span class="lineNum">     252 </span>                :            :     else
<span class="lineNum">     253 </span>                :            :     {
<span class="lineNum">     254 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;firewd_chk_support() -C not supported&quot;);</span>
<span class="lineNum">     255 </span>                :<span class="lineNoCov">          0 :         have_firewd_chk_support = 0;</span>
<span class="lineNum">     256 </span>                :            :     }
<span class="lineNum">     257 </span>                :            : 
<span class="lineNum">     258 </span>                :            :     /* Delete the tmp rule
<span class="lineNum">     259 </span>                :            :     */
<span class="lineNum">     260 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     261 </span>                :            : 
<span class="lineNum">     262 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_DEL_RULE_ARGS,
<span class="lineNum">     263 </span>                :<span class="lineNoCov">          0 :         opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">     264 </span>                :            :         in_chain-&gt;table,
<span class="lineNum">     265 </span>                :            :         in_chain-&gt;from_chain,
<span class="lineNum">     266 </span>                :            :         1
<span class="lineNum">     267 </span>                :            :     );
<span class="lineNum">     268 </span>                :<span class="lineNoCov">          0 :     run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">     269 </span>                :            :             WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     270 </span>                :            : 
<span class="lineNum">     271 </span>                :<span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     272 </span>                :            : }
<a name="273"><span class="lineNum">     273 </span>                :            : </a>
<span class="lineNum">     274 </span>                :            : static int
<span class="lineNum">     275 </span>                :<span class="lineNoCov">          0 : comment_match_exists(const fko_srv_options_t * const opts)</span>
<span class="lineNum">     276 </span>                :            : {
<span class="lineNum">     277 </span>                :<span class="lineNoCov">          0 :     int               res = 1;</span>
<span class="lineNum">     278 </span>                :<span class="lineNoCov">          0 :     char             *ndx = NULL;</span>
<span class="lineNum">     279 </span>                :<span class="lineNoCov">          0 :     struct fw_chain  *in_chain  = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_INPUT_ACCESS]);</span>
<span class="lineNum">     280 </span>                :            : 
<span class="lineNum">     281 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     282 </span>                :            : 
<span class="lineNum">     283 </span>                :            :     /* Add a harmless rule to the firewalld INPUT chain that uses the comment
<span class="lineNum">     284 </span>                :            :      * match and make sure it exists.  If not, return zero.  Otherwise, delete
<span class="lineNum">     285 </span>                :            :      * the rule and return true.
<span class="lineNum">     286 </span>                :            :     */
<span class="lineNum">     287 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_TMP_COMMENT_ARGS,
<span class="lineNum">     288 </span>                :<span class="lineNoCov">          0 :         opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">     289 </span>                :<span class="lineNoCov">          0 :         in_chain-&gt;table,</span>
<span class="lineNum">     290 </span>                :<span class="lineNoCov">          0 :         in_chain-&gt;from_chain,</span>
<span class="lineNum">     291 </span>                :            :         1,   /* first rule */
<span class="lineNum">     292 </span>                :<span class="lineNoCov">          0 :         in_chain-&gt;target</span>
<span class="lineNum">     293 </span>                :            :     );
<span class="lineNum">     294 </span>                :            : 
<span class="lineNum">     295 </span>                :<span class="lineNoCov">          0 :     res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">     296 </span>                :            :             WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     297 </span>                :<span class="lineNoCov">          0 :     chop_newline(err_buf);</span>
<span class="lineNum">     298 </span>                :            : 
<span class="lineNum">     299 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG, &quot;comment_match_exists() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     300 </span>                :            :             cmd_buf, res, err_buf);
<span class="lineNum">     301 </span>                :            : 
<span class="lineNum">     302 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     303 </span>                :            : 
<span class="lineNum">     304 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_LIST_RULES_ARGS,
<span class="lineNum">     305 </span>                :<span class="lineNoCov">          0 :         opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">     306 </span>                :            :         in_chain-&gt;table,
<span class="lineNum">     307 </span>                :            :         in_chain-&gt;from_chain
<span class="lineNum">     308 </span>                :            :     );
<span class="lineNum">     309 </span>                :            : 
<span class="lineNum">     310 </span>                :<span class="lineNoCov">          0 :     res = run_extcmd(cmd_buf, cmd_out, STANDARD_CMD_OUT_BUFSIZE,</span>
<span class="lineNum">     311 </span>                :            :             WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     312 </span>                :<span class="lineNoCov">          0 :     chop_newline(cmd_out);</span>
<span class="lineNum">     313 </span>                :            : 
<span class="lineNum">     314 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(!EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">     315 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, cmd_out);</span>
<span class="lineNum">     316 </span>                :            : 
<span class="lineNum">     317 </span>                :<span class="lineNoCov">          0 :     ndx = strstr(cmd_out, TMP_COMMENT);</span>
<span class="lineNum">     318 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(ndx == NULL)</span>
<span class="lineNum">     319 </span>                :            :         res = 0;  /* did not find the tmp comment */
<span class="lineNum">     320 </span>                :            :     else
<span class="lineNum">     321 </span>                :<span class="lineNoCov">          0 :         res = 1;</span>
<span class="lineNum">     322 </span>                :            : 
<span class="lineNum">     323 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(res == 1)</span>
<span class="lineNum">     324 </span>                :            :     {
<span class="lineNum">     325 </span>                :            :         /* Delete the tmp comment rule
<span class="lineNum">     326 </span>                :            :         */
<span class="lineNum">     327 </span>                :<span class="lineNoCov">          0 :         zero_cmd_buffers();</span>
<span class="lineNum">     328 </span>                :            : 
<span class="lineNum">     329 </span>                :            :         snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_DEL_RULE_ARGS,
<span class="lineNum">     330 </span>                :<span class="lineNoCov">          0 :             opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">     331 </span>                :            :             in_chain-&gt;table,
<span class="lineNum">     332 </span>                :            :             in_chain-&gt;from_chain,
<span class="lineNum">     333 </span>                :            :             1
<span class="lineNum">     334 </span>                :            :         );
<span class="lineNum">     335 </span>                :<span class="lineNoCov">          0 :         run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">     336 </span>                :            :                 WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     337 </span>                :            :     }
<span class="lineNum">     338 </span>                :            : 
<span class="lineNum">     339 </span>                :<span class="lineNoCov">          0 :     return res;</span>
<span class="lineNum">     340 </span>                :            : }
<a name="341"><span class="lineNum">     341 </span>                :            : </a>
<span class="lineNum">     342 </span>                :            : static int
<span class="lineNum">     343 </span>                :<span class="lineNoCov">          0 : add_jump_rule(const fko_srv_options_t * const opts, const int chain_num)</span>
<span class="lineNum">     344 </span>                :            : {
<span class="lineNum">     345 </span>                :<span class="lineNoCov">          0 :     int res = 0, rv = 0;</span>
<span class="lineNum">     346 </span>                :            : 
<span class="lineNum">     347 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     348 </span>                :            : 
<span class="lineNum">     349 </span>                :<span class="lineNoCov">          0 :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_ADD_JUMP_RULE_ARGS,</span>
<span class="lineNum">     350 </span>                :            :         fwc.fw_command,
<span class="lineNum">     351 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].table,</span>
<span class="lineNum">     352 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].from_chain,</span>
<span class="lineNum">     353 </span>                :            :         fwc.chain[chain_num].jump_rule_pos,
<span class="lineNum">     354 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].to_chain</span>
<span class="lineNum">     355 </span>                :            :     );
<span class="lineNum">     356 </span>                :            : 
<span class="lineNum">     357 </span>                :<span class="lineNoCov">          0 :     res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">     358 </span>                :            :             WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     359 </span>                :            : 
<span class="lineNum">     360 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG, &quot;add_jump_rule() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     361 </span>                :            :         cmd_buf, res, err_buf);
<span class="lineNum">     362 </span>                :            : 
<span class="lineNum">     363 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">     364 </span>                :            :     {
<span class="lineNum">     365 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_INFO, &quot;Added jump rule from chain: %s to chain: %s&quot;,</span>
<span class="lineNum">     366 </span>                :            :             fwc.chain[chain_num].from_chain,
<span class="lineNum">     367 </span>                :            :             fwc.chain[chain_num].to_chain);
<span class="lineNum">     368 </span>                :<span class="lineNoCov">          0 :         rv = 1;</span>
<span class="lineNum">     369 </span>                :            :     }
<span class="lineNum">     370 </span>                :            :     else
<span class="lineNum">     371 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">     372 </span>                :            : 
<span class="lineNum">     373 </span>                :<span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">     374 </span>                :            : }
<a name="375"><span class="lineNum">     375 </span>                :            : </a>
<span class="lineNum">     376 </span>                :            : static int
<span class="lineNum">     377 </span>                :<span class="lineNoCov">          0 : chain_exists(const fko_srv_options_t * const opts, const int chain_num)</span>
<span class="lineNum">     378 </span>                :            : {
<span class="lineNum">     379 </span>                :<span class="lineNoCov">          0 :     int res = 0, rv = 0;</span>
<span class="lineNum">     380 </span>                :            : 
<span class="lineNum">     381 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     382 </span>                :            : 
<span class="lineNum">     383 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_CHAIN_EXISTS_ARGS,
<span class="lineNum">     384 </span>                :            :         fwc.fw_command,
<span class="lineNum">     385 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].table,</span>
<span class="lineNum">     386 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].to_chain</span>
<span class="lineNum">     387 </span>                :            :     );
<span class="lineNum">     388 </span>                :            : 
<span class="lineNum">     389 </span>                :<span class="lineNoCov">          0 :     res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">     390 </span>                :            :             WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     391 </span>                :<span class="lineNoCov">          0 :     chop_newline(err_buf);</span>
<span class="lineNum">     392 </span>                :            : 
<span class="lineNum">     393 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG, &quot;chain_exists() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     394 </span>                :            :         cmd_buf, res, err_buf);
<span class="lineNum">     395 </span>                :            : 
<span class="lineNum">     396 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(strstr(err_buf, FIREWD_CMD_FAIL_STR) == NULL)</span>
<span class="lineNum">     397 </span>                :            :     {
<span class="lineNum">     398 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;'%s' table '%s' chain exists&quot;,</span>
<span class="lineNum">     399 </span>                :            :             fwc.chain[chain_num].table,
<span class="lineNum">     400 </span>                :            :             fwc.chain[chain_num].to_chain);
<span class="lineNum">     401 </span>                :<span class="lineNoCov">          0 :         rv = 1;</span>
<span class="lineNum">     402 </span>                :            :     }
<span class="lineNum">     403 </span>                :            :     else
<span class="lineNum">     404 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">     405 </span>                :            : 
<span class="lineNum">     406 </span>                :<span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">     407 </span>                :            : }
<a name="408"><span class="lineNum">     408 </span>                :            : </a>
<span class="lineNum">     409 </span>                :            : static int
<span class="lineNum">     410 </span>                :<span class="lineNoCov">          0 : jump_rule_exists_chk_support(const fko_srv_options_t * const opts, const int chain_num)</span>
<span class="lineNum">     411 </span>                :            : {
<span class="lineNum">     412 </span>                :<span class="lineNoCov">          0 :     int    exists = 0;</span>
<span class="lineNum">     413 </span>                :<span class="lineNoCov">          0 :     char   rule_buf[CMD_BUFSIZE] = {0};</span>
<span class="lineNum">     414 </span>                :            : 
<span class="lineNum">     415 </span>                :            :     snprintf(rule_buf, CMD_BUFSIZE-1, FIREWD_CHK_JUMP_RULE_ARGS,
<span class="lineNum">     416 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].table,</span>
<span class="lineNum">     417 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].to_chain</span>
<span class="lineNum">     418 </span>                :            :     );
<span class="lineNum">     419 </span>                :            : 
<span class="lineNum">     420 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(rule_exists_chk_support(opts, fwc.chain[chain_num].from_chain, rule_buf) == 1)</span>
<span class="lineNum">     421 </span>                :            :     {
<span class="lineNum">     422 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;jump_rule_exists_chk_support() jump rule found&quot;);</span>
<span class="lineNum">     423 </span>                :<span class="lineNoCov">          0 :         exists = 1;</span>
<span class="lineNum">     424 </span>                :            :     }
<span class="lineNum">     425 </span>                :            :     else
<span class="lineNum">     426 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;jump_rule_exists_chk_support() jump rule not found&quot;);</span>
<span class="lineNum">     427 </span>                :            : 
<span class="lineNum">     428 </span>                :<span class="lineNoCov">          0 :     return exists;</span>
<span class="lineNum">     429 </span>                :            : }
<a name="430"><span class="lineNum">     430 </span>                :            : </a>
<span class="lineNum">     431 </span>                :            : static int
<span class="lineNum">     432 </span>                :<span class="lineNoCov">          0 : jump_rule_exists_no_chk_support(const fko_srv_options_t * const opts, const int chain_num)</span>
<span class="lineNum">     433 </span>                :            : {
<span class="lineNum">     434 </span>                :<span class="lineNoCov">          0 :     int     exists = 0;</span>
<span class="lineNum">     435 </span>                :<span class="lineNoCov">          0 :     char    cmd_buf[CMD_BUFSIZE]      = {0};</span>
<span class="lineNum">     436 </span>                :<span class="lineNoCov">          0 :     char    chain_search[CMD_BUFSIZE] = {0};</span>
<span class="lineNum">     437 </span>                :            : 
<span class="lineNum">     438 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_LIST_RULES_ARGS,
<span class="lineNum">     439 </span>                :            :         fwc.fw_command,
<span class="lineNum">     440 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].table,</span>
<span class="lineNum">     441 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].from_chain</span>
<span class="lineNum">     442 </span>                :            :     );
<span class="lineNum">     443 </span>                :            : 
<span class="lineNum">     444 </span>                :            :     /* include spaces on either side as produced by 'firewalld -L' output
<span class="lineNum">     445 </span>                :            :     */
<span class="lineNum">     446 </span>                :            :     snprintf(chain_search, CMD_BUFSIZE-1, &quot; %s &quot;,
<span class="lineNum">     447 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].to_chain);</span>
<span class="lineNum">     448 </span>                :            : 
<span class="lineNum">     449 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(search_extcmd(cmd_buf, WANT_STDERR,</span>
<span class="lineNum">     450 </span>                :            :                 NO_TIMEOUT, chain_search, &amp;pid_status, opts) &gt; 0)
<span class="lineNum">     451 </span>                :<span class="lineNoCov">          0 :         exists = 1;</span>
<span class="lineNum">     452 </span>                :            : 
<span class="lineNum">     453 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(exists)</span>
<span class="lineNum">     454 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;jump_rule_exists_no_chk_support() jump rule found&quot;);</span>
<span class="lineNum">     455 </span>                :            :     else
<span class="lineNum">     456 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;jump_rule_exists_no_chk_support() jump rule not found&quot;);</span>
<span class="lineNum">     457 </span>                :            : 
<span class="lineNum">     458 </span>                :<span class="lineNoCov">          0 :    return(exists);</span>
<span class="lineNum">     459 </span>                :            : }
<a name="460"><span class="lineNum">     460 </span>                :            : </a>
<span class="lineNum">     461 </span>                :            : static int
<span class="lineNum">     462 </span>                :<span class="lineNoCov">          0 : jump_rule_exists(const fko_srv_options_t * const opts, const int chain_num)</span>
<span class="lineNum">     463 </span>                :            : {
<span class="lineNum">     464 </span>                :<span class="lineNoCov">          0 :     int    exists = 0;</span>
<span class="lineNum">     465 </span>                :            : 
<span class="lineNum">     466 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(have_firewd_chk_support == 1)</span>
<span class="lineNum">     467 </span>                :<span class="lineNoCov">          0 :         exists = jump_rule_exists_chk_support(opts, chain_num);</span>
<span class="lineNum">     468 </span>                :            :     else
<span class="lineNum">     469 </span>                :<span class="lineNoCov">          0 :         exists = jump_rule_exists_no_chk_support(opts, chain_num);</span>
<span class="lineNum">     470 </span>                :            : 
<span class="lineNum">     471 </span>                :<span class="lineNoCov">          0 :     return exists;</span>
<span class="lineNum">     472 </span>                :            : }
<span class="lineNum">     473 </span>                :            : 
<span class="lineNum">     474 </span>                :            : /* Print all firewall rules currently instantiated by the running fwknopd
<span class="lineNum">     475 </span>                :            :  * daemon to stdout.
<a name="476"><span class="lineNum">     476 </span>                :            : */</a>
<span class="lineNum">     477 </span>                :            : int
<span class="lineNum">     478 </span>                :<span class="lineNoCov">          0 : fw_dump_rules(const fko_srv_options_t * const opts)</span>
<span class="lineNum">     479 </span>                :            : {
<span class="lineNum">     480 </span>                :            :     int     i;
<span class="lineNum">     481 </span>                :<span class="lineNoCov">          0 :     int     res, got_err = 0;</span>
<span class="lineNum">     482 </span>                :            : 
<span class="lineNum">     483 </span>                :<span class="lineNoCov">          0 :     struct fw_chain *ch = opts-&gt;fw_config-&gt;chain;</span>
<span class="lineNum">     484 </span>                :            : 
<span class="lineNum">     485 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (opts-&gt;fw_list_all == 1)</span>
<span class="lineNum">     486 </span>                :            :     {
<span class="lineNum">     487 </span>                :<span class="lineNoCov">          0 :         fprintf(stdout, &quot;Listing all firewalld rules in applicable tables...\n&quot;);</span>
<span class="lineNum">     488 </span>                :<span class="lineNoCov">          0 :         fflush(stdout);</span>
<span class="lineNum">     489 </span>                :            : 
<span class="lineNum">     490 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(i=0; i &lt; NUM_FWKNOP_ACCESS_TYPES; i++)</span>
<span class="lineNum">     491 </span>                :            :         {
<span class="lineNum">     492 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(fwc.chain[i].target[0] == '\0')</span>
<span class="lineNum">     493 </span>                :<span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     494 </span>                :            : 
<span class="lineNum">     495 </span>                :<span class="lineNoCov">          0 :             zero_cmd_buffers();</span>
<span class="lineNum">     496 </span>                :            : 
<span class="lineNum">     497 </span>                :            :             /* Create the list command
<span class="lineNum">     498 </span>                :            :             */
<span class="lineNum">     499 </span>                :            :             snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_LIST_ALL_RULES_ARGS,
<span class="lineNum">     500 </span>                :<span class="lineNoCov">          0 :                 opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">     501 </span>                :<span class="lineNoCov">          0 :                 ch[i].table</span>
<span class="lineNum">     502 </span>                :            :             );
<span class="lineNum">     503 </span>                :            : 
<span class="lineNum">     504 </span>                :<span class="lineNoCov">          0 :             res = run_extcmd(cmd_buf, NULL, 0, NO_STDERR,</span>
<span class="lineNum">     505 </span>                :            :                         NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     506 </span>                :            : 
<span class="lineNum">     507 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_DEBUG, &quot;fw_dump_rules() CMD: '%s' (res: %d)&quot;,</span>
<span class="lineNum">     508 </span>                :            :                 cmd_buf, res);
<span class="lineNum">     509 </span>                :            : 
<span class="lineNum">     510 </span>                :            :             /* Expect full success on this */
<span class="lineNum">     511 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(! EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">     512 </span>                :            :             {
<span class="lineNum">     513 </span>                :<span class="lineNoCov">          0 :                 log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">     514 </span>                :<span class="lineNoCov">          0 :                 got_err++;</span>
<span class="lineNum">     515 </span>                :            :             }
<span class="lineNum">     516 </span>                :            :         }
<span class="lineNum">     517 </span>                :            :     }
<span class="lineNum">     518 </span>                :            :     else
<span class="lineNum">     519 </span>                :            :     {
<span class="lineNum">     520 </span>                :<span class="lineNoCov">          0 :         fprintf(stdout, &quot;Listing rules in fwknopd firewalld chains...\n&quot;);</span>
<span class="lineNum">     521 </span>                :<span class="lineNoCov">          0 :         fflush(stdout);</span>
<span class="lineNum">     522 </span>                :            : 
<span class="lineNum">     523 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(i=0; i &lt; NUM_FWKNOP_ACCESS_TYPES; i++)</span>
<span class="lineNum">     524 </span>                :            :         {
<span class="lineNum">     525 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(fwc.chain[i].target[0] == '\0')</span>
<span class="lineNum">     526 </span>                :<span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">     527 </span>                :            : 
<span class="lineNum">     528 </span>                :<span class="lineNoCov">          0 :             zero_cmd_buffers();</span>
<span class="lineNum">     529 </span>                :            : 
<span class="lineNum">     530 </span>                :            :             /* Create the list command
<span class="lineNum">     531 </span>                :            :             */
<span class="lineNum">     532 </span>                :            :             snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_LIST_RULES_ARGS,
<span class="lineNum">     533 </span>                :<span class="lineNoCov">          0 :                 opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">     534 </span>                :<span class="lineNoCov">          0 :                 ch[i].table,</span>
<span class="lineNum">     535 </span>                :<span class="lineNoCov">          0 :                 ch[i].to_chain</span>
<span class="lineNum">     536 </span>                :            :             );
<span class="lineNum">     537 </span>                :            : 
<span class="lineNum">     538 </span>                :<span class="lineNoCov">          0 :             fprintf(stdout, &quot;\n&quot;);</span>
<span class="lineNum">     539 </span>                :<span class="lineNoCov">          0 :             fflush(stdout);</span>
<span class="lineNum">     540 </span>                :            : 
<span class="lineNum">     541 </span>                :<span class="lineNoCov">          0 :             res = run_extcmd(cmd_buf, NULL, 0, NO_STDERR,</span>
<span class="lineNum">     542 </span>                :            :                         NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     543 </span>                :            : 
<span class="lineNum">     544 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_DEBUG, &quot;fw_dump_rules() CMD: '%s' (res: %d)&quot;,</span>
<span class="lineNum">     545 </span>                :            :                 cmd_buf, res);
<span class="lineNum">     546 </span>                :            : 
<span class="lineNum">     547 </span>                :            :             /* Expect full success on this */
<span class="lineNum">     548 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(! EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">     549 </span>                :            :             {
<span class="lineNum">     550 </span>                :<span class="lineNoCov">          0 :                 log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">     551 </span>                :<span class="lineNoCov">          0 :                 got_err++;</span>
<span class="lineNum">     552 </span>                :            :             }
<span class="lineNum">     553 </span>                :            :         }
<span class="lineNum">     554 </span>                :            :     }
<span class="lineNum">     555 </span>                :            : 
<span class="lineNum">     556 </span>                :<span class="lineNoCov">          0 :     return(got_err);</span>
<span class="lineNum">     557 </span>                :            : }
<span class="lineNum">     558 </span>                :            : 
<span class="lineNum">     559 </span>                :            : /* Quietly flush and delete all fwknop custom chains.
<a name="560"><span class="lineNum">     560 </span>                :            : */</a>
<span class="lineNum">     561 </span>                :            : static void
<span class="lineNum">     562 </span>                :<span class="lineNoCov">          0 : delete_all_chains(const fko_srv_options_t * const opts)</span>
<span class="lineNum">     563 </span>                :            : {
<span class="lineNum">     564 </span>                :<span class="lineNoCov">          0 :     int     i, res, cmd_ctr = 0;</span>
<span class="lineNum">     565 </span>                :            : 
<span class="lineNum">     566 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for(i=0; i &lt; NUM_FWKNOP_ACCESS_TYPES; i++)</span>
<span class="lineNum">     567 </span>                :            :     {
<span class="lineNum">     568 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(fwc.chain[i].target[0] == '\0')</span>
<span class="lineNum">     569 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     570 </span>                :            : 
<span class="lineNum">     571 </span>                :            :         /* First look for a jump rule to this chain and remove it if it
<span class="lineNum">     572 </span>                :            :          * is there.
<span class="lineNum">     573 </span>                :            :         */
<span class="lineNum">     574 </span>                :            :         cmd_ctr = 0;
<span class="lineNum">     575 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while(cmd_ctr &lt; CMD_LOOP_TRIES &amp;&amp; (jump_rule_exists(opts, i) == 1))</span>
<span class="lineNum">     576 </span>                :            :         {
<span class="lineNum">     577 </span>                :<span class="lineNoCov">          0 :             zero_cmd_buffers();</span>
<span class="lineNum">     578 </span>                :            : 
<span class="lineNum">     579 </span>                :            :             snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_DEL_JUMP_RULE_ARGS,
<span class="lineNum">     580 </span>                :            :                 fwc.fw_command,
<span class="lineNum">     581 </span>                :<span class="lineNoCov">          0 :                 fwc.chain[i].table,</span>
<span class="lineNum">     582 </span>                :<span class="lineNoCov">          0 :                 fwc.chain[i].from_chain,</span>
<span class="lineNum">     583 </span>                :<span class="lineNoCov">          0 :                 fwc.chain[i].to_chain</span>
<span class="lineNum">     584 </span>                :            :             );
<span class="lineNum">     585 </span>                :            : 
<span class="lineNum">     586 </span>                :<span class="lineNoCov">          0 :             res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">     587 </span>                :            :                     WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     588 </span>                :<span class="lineNoCov">          0 :             chop_newline(err_buf);</span>
<span class="lineNum">     589 </span>                :            : 
<span class="lineNum">     590 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_DEBUG, &quot;delete_all_chains() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     591 </span>                :            :                 cmd_buf, res, err_buf);
<span class="lineNum">     592 </span>                :            : 
<span class="lineNum">     593 </span>                :            :             /* Expect full success on this */
<span class="lineNum">     594 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(! EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">     595 </span>                :<span class="lineNoCov">          0 :                 log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">     596 </span>                :            : 
<span class="lineNum">     597 </span>                :<span class="lineNoCov">          0 :             cmd_ctr++;</span>
<span class="lineNum">     598 </span>                :            :         }
<span class="lineNum">     599 </span>                :            : 
<span class="lineNum">     600 </span>                :<span class="lineNoCov">          0 :         zero_cmd_buffers();</span>
<span class="lineNum">     601 </span>                :            : 
<span class="lineNum">     602 </span>                :            :         /* Now flush and remove the chain.
<span class="lineNum">     603 </span>                :            :         */
<span class="lineNum">     604 </span>                :            :         snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_FLUSH_CHAIN_ARGS,
<span class="lineNum">     605 </span>                :            :             fwc.fw_command,
<span class="lineNum">     606 </span>                :<span class="lineNoCov">          0 :             fwc.chain[i].table,</span>
<span class="lineNum">     607 </span>                :<span class="lineNoCov">          0 :             fwc.chain[i].to_chain</span>
<span class="lineNum">     608 </span>                :            :         );
<span class="lineNum">     609 </span>                :            : 
<span class="lineNum">     610 </span>                :<span class="lineNoCov">          0 :         res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE, WANT_STDERR,</span>
<span class="lineNum">     611 </span>                :            :                 NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     612 </span>                :<span class="lineNoCov">          0 :         chop_newline(err_buf);</span>
<span class="lineNum">     613 </span>                :            : 
<span class="lineNum">     614 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;delete_all_chains() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     615 </span>                :            :             cmd_buf, res, err_buf);
<span class="lineNum">     616 </span>                :            : 
<span class="lineNum">     617 </span>                :            :         /* Expect full success on this */
<span class="lineNum">     618 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(! EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">     619 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">     620 </span>                :            : 
<span class="lineNum">     621 </span>                :<span class="lineNoCov">          0 :         zero_cmd_buffers();</span>
<span class="lineNum">     622 </span>                :            : 
<span class="lineNum">     623 </span>                :            :         snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_DEL_CHAIN_ARGS,
<span class="lineNum">     624 </span>                :            :             fwc.fw_command,
<span class="lineNum">     625 </span>                :<span class="lineNoCov">          0 :             fwc.chain[i].table,</span>
<span class="lineNum">     626 </span>                :            :             fwc.chain[i].to_chain
<span class="lineNum">     627 </span>                :            :         );
<span class="lineNum">     628 </span>                :            : 
<span class="lineNum">     629 </span>                :<span class="lineNoCov">          0 :         res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE, WANT_STDERR,</span>
<span class="lineNum">     630 </span>                :            :                 NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     631 </span>                :<span class="lineNoCov">          0 :         chop_newline(err_buf);</span>
<span class="lineNum">     632 </span>                :            : 
<span class="lineNum">     633 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;delete_all_chains() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     634 </span>                :            :             cmd_buf, res, err_buf);
<span class="lineNum">     635 </span>                :            : 
<span class="lineNum">     636 </span>                :            :         /* Expect full success on this */
<span class="lineNum">     637 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(! EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">     638 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">     639 </span>                :            : 
<span class="lineNum">     640 </span>                :            :     }
<span class="lineNum">     641 </span>                :<span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     642 </span>                :            : }
<a name="643"><span class="lineNum">     643 </span>                :            : </a>
<span class="lineNum">     644 </span>                :            : static int
<span class="lineNum">     645 </span>                :<span class="lineNoCov">          0 : create_chain(const fko_srv_options_t * const opts, const int chain_num)</span>
<span class="lineNum">     646 </span>                :            : {
<span class="lineNum">     647 </span>                :<span class="lineNoCov">          0 :     int res = 0, rv = 0;</span>
<span class="lineNum">     648 </span>                :            : 
<span class="lineNum">     649 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     650 </span>                :            : 
<span class="lineNum">     651 </span>                :            :     /* Create the custom chain.
<span class="lineNum">     652 </span>                :            :     */
<span class="lineNum">     653 </span>                :            :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_NEW_CHAIN_ARGS,
<span class="lineNum">     654 </span>                :            :         fwc.fw_command,
<span class="lineNum">     655 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].table,</span>
<span class="lineNum">     656 </span>                :<span class="lineNoCov">          0 :         fwc.chain[chain_num].to_chain</span>
<span class="lineNum">     657 </span>                :            :     );
<span class="lineNum">     658 </span>                :            : 
<span class="lineNum">     659 </span>                :<span class="lineNoCov">          0 :     res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE, WANT_STDERR,</span>
<span class="lineNum">     660 </span>                :            :                 NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     661 </span>                :<span class="lineNoCov">          0 :     chop_newline(err_buf);</span>
<span class="lineNum">     662 </span>                :            : 
<span class="lineNum">     663 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG, &quot;create_chain() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     664 </span>                :            :         cmd_buf, res, err_buf);
<span class="lineNum">     665 </span>                :            : 
<span class="lineNum">     666 </span>                :            :     /* Expect full success on this */
<span class="lineNum">     667 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">     668 </span>                :            :         rv = 1;
<span class="lineNum">     669 </span>                :            :     else
<span class="lineNum">     670 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">     671 </span>                :            : 
<span class="lineNum">     672 </span>                :<span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">     673 </span>                :            : }
<a name="674"><span class="lineNum">     674 </span>                :            : </a>
<span class="lineNum">     675 </span>                :            : static int
<span class="lineNum">     676 </span>                :<span class="lineNoCov">          0 : mk_chain(const fko_srv_options_t * const opts, const int chain_num)</span>
<span class="lineNum">     677 </span>                :            : {
<span class="lineNum">     678 </span>                :<span class="lineNoCov">          0 :     int err = 0;</span>
<span class="lineNum">     679 </span>                :            : 
<span class="lineNum">     680 </span>                :            :     /* Make sure the required chain and jump rule exist
<span class="lineNum">     681 </span>                :            :     */
<span class="lineNum">     682 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(! chain_exists(opts, chain_num))</span>
<span class="lineNum">     683 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(! create_chain(opts, chain_num))</span>
<span class="lineNum">     684 </span>                :<span class="lineNoCov">          0 :             err++;</span>
<span class="lineNum">     685 </span>                :            : 
<span class="lineNum">     686 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (! jump_rule_exists(opts, chain_num))</span>
<span class="lineNum">     687 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(! add_jump_rule(opts, chain_num))</span>
<span class="lineNum">     688 </span>                :<span class="lineNoCov">          0 :             err++;</span>
<span class="lineNum">     689 </span>                :            : 
<span class="lineNum">     690 </span>                :<span class="lineNoCov">          0 :     return err;</span>
<span class="lineNum">     691 </span>                :            : }
<span class="lineNum">     692 </span>                :            : 
<span class="lineNum">     693 </span>                :            : /* Create the fwknop custom chains (at least those that are configured).
<a name="694"><span class="lineNum">     694 </span>                :            : */</a>
<span class="lineNum">     695 </span>                :            : static int
<span class="lineNum">     696 </span>                :<span class="lineNoCov">          0 : create_fw_chains(const fko_srv_options_t * const opts)</span>
<span class="lineNum">     697 </span>                :            : {
<span class="lineNum">     698 </span>                :<span class="lineNoCov">          0 :     int     i, got_err = 0;</span>
<span class="lineNum">     699 </span>                :            : 
<span class="lineNum">     700 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for(i=0; i &lt; NUM_FWKNOP_ACCESS_TYPES; i++)</span>
<span class="lineNum">     701 </span>                :            :     {
<span class="lineNum">     702 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(fwc.chain[i].target[0] == '\0')</span>
<span class="lineNum">     703 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     704 </span>                :            : 
<span class="lineNum">     705 </span>                :<span class="lineNoCov">          0 :         got_err += mk_chain(opts, i);</span>
<span class="lineNum">     706 </span>                :            :     }
<span class="lineNum">     707 </span>                :            : 
<span class="lineNum">     708 </span>                :<span class="lineNoCov">          0 :     return(got_err);</span>
<span class="lineNum">     709 </span>                :            : }
<a name="710"><span class="lineNum">     710 </span>                :            : </a>
<span class="lineNum">     711 </span>                :            : static int
<span class="lineNum">     712 </span>                :<span class="lineCov">        795 : set_fw_chain_conf(const int type, const char * const conf_str)</span>
<span class="lineNum">     713 </span>                :            : {
<span class="lineNum">     714 </span>                :            :     int i, j, is_err;
<span class="lineNum">     715 </span>                :<span class="lineCov">        795 :     char tbuf[MAX_LINE_LEN]  = {0};</span>
<span class="lineNum">     716 </span>                :<span class="lineCov">        795 :     const char *ndx          = conf_str;</span>
<span class="lineNum">     717 </span>                :            : 
<span class="lineNum">     718 </span>                :            :     char *chain_fields[FW_NUM_CHAIN_FIELDS];
<span class="lineNum">     719 </span>                :            : 
<span class="lineNum">     720 </span>                :<span class="lineCov">        795 :     struct fw_chain *chain = &amp;(fwc.chain[type]);</span>
<span class="lineNum">     721 </span>                :            : 
<span class="lineNum">     722 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 795 times"> + </span>]:<span class="lineCov">        795 :     if(conf_str == NULL)</span>
<span class="lineNum">     723 </span>                :            :     {
<span class="lineNum">     724 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_ERR, &quot;[*] NULL conf_str&quot;);</span>
<span class="lineNum">     725 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     726 </span>                :            :     }
<span class="lineNum">     727 </span>                :            : 
<span class="lineNum">     728 </span>                :<span class="lineCov">        795 :     chain-&gt;type = type;</span>
<span class="lineNum">     729 </span>                :            : 
<span class="lineNum">     730 </span>        [<span class="branchCov" title="Branch 0 was taken 795 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        795 :     if(ndx != NULL)</span>
<span class="lineNum">     731 </span>                :<span class="lineCov">        795 :         chain_fields[0] = tbuf;</span>
<span class="lineNum">     732 </span>                :            : 
<span class="lineNum">     733 </span>                :            :     i = 0;
<span class="lineNum">     734 </span>                :            :     j = 1;
<span class="lineNum">     735 </span>        [<span class="branchCov" title="Branch 0 was taken 32595 times"> + </span><span class="branchCov" title="Branch 1 was taken 795 times"> + </span>]:<span class="lineCov">      33390 :     while(*ndx != '\0')</span>
<span class="lineNum">     736 </span>                :            :     {
<span class="lineNum">     737 </span>        [<span class="branchCov" title="Branch 0 was taken 28620 times"> + </span><span class="branchCov" title="Branch 1 was taken 3975 times"> + </span>]:<span class="lineCov">      32595 :         if(*ndx != ' ')</span>
<span class="lineNum">     738 </span>                :            :         {
<span class="lineNum">     739 </span>        [<span class="branchCov" title="Branch 0 was taken 3975 times"> + </span><span class="branchCov" title="Branch 1 was taken 24645 times"> + </span>]:<span class="lineCov">      28620 :             if(*ndx == ',')</span>
<span class="lineNum">     740 </span>                :            :             {
<span class="lineNum">     741 </span>                :<span class="lineCov">       3975 :                 tbuf[i] = '\0';</span>
<span class="lineNum">     742 </span>                :<span class="lineCov">       3975 :                 chain_fields[j++] = &amp;(tbuf[++i]);</span>
<span class="lineNum">     743 </span>                :            :             }
<span class="lineNum">     744 </span>                :            :             else
<span class="lineNum">     745 </span>                :<span class="lineCov">      24645 :                 tbuf[i++] = *ndx;</span>
<span class="lineNum">     746 </span>                :            :         }
<span class="lineNum">     747 </span>        [<span class="branchCov" title="Branch 0 was taken 28620 times"> + </span><span class="branchCov" title="Branch 1 was taken 3975 times"> + </span>]:<span class="lineCov">      32595 :         if(*ndx != '\0'</span>
<span class="lineNum">     748 </span>                :<span class="lineCov">      32595 :                 &amp;&amp; *ndx != ' '</span>
<span class="lineNum">     749 </span>        [<span class="branchCov" title="Branch 0 was taken 24645 times"> + </span><span class="branchCov" title="Branch 1 was taken 3975 times"> + </span>]:<span class="lineCov">      28620 :                 &amp;&amp; *ndx != ','</span>
<span class="lineNum">     750 </span>        [<span class="branchCov" title="Branch 0 was taken 23850 times"> + </span><span class="branchCov" title="Branch 1 was taken 795 times"> + </span>]:<span class="lineCov">      24645 :                 &amp;&amp; *ndx != '_'</span>
<span class="lineNum">     751 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 23850 times"> + </span>]:<span class="lineCov">      23850 :                 &amp;&amp; isalnum(*ndx) == 0)</span>
<span class="lineNum">     752 </span>                :            :         {
<span class="lineNum">     753 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_ERR, &quot;[*] Custom chain config parse error: &quot;</span>
<span class="lineNum">     754 </span>                :            :                 &quot;invalid character '%c' for chain type %i, &quot;
<span class="lineNum">     755 </span>                :<span class="lineNoCov">          0 :                 &quot;line: %s&quot;, *ndx, type, conf_str);</span>
<span class="lineNum">     756 </span>                :<span class="lineNoCov">          0 :             return 0;</span>
<span class="lineNum">     757 </span>                :            :         }
<span class="lineNum">     758 </span>                :<span class="lineCov">      32595 :         ndx++;</span>
<span class="lineNum">     759 </span>                :            :     }
<span class="lineNum">     760 </span>                :            : 
<span class="lineNum">     761 </span>                :            :     /* Sanity check - j should be the number of chain fields
<span class="lineNum">     762 </span>                :            :      * (excluding the type).
<span class="lineNum">     763 </span>                :            :     */
<span class="lineNum">     764 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 795 times"> + </span>]:<span class="lineCov">        795 :     if(j != FW_NUM_CHAIN_FIELDS)</span>
<span class="lineNum">     765 </span>                :            :     {
<span class="lineNum">     766 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_ERR, &quot;[*] Custom chain config parse error: &quot;</span>
<span class="lineNum">     767 </span>                :            :             &quot;wrong number of fields for chain type %i, &quot;
<span class="lineNum">     768 </span>                :            :             &quot;line: %s&quot;, type, conf_str);
<span class="lineNum">     769 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     770 </span>                :            :     }
<span class="lineNum">     771 </span>                :            : 
<span class="lineNum">     772 </span>                :            :     /* Pull and set Target */
<span class="lineNum">     773 </span>                :<span class="lineCov">        795 :     strlcpy(chain-&gt;target, chain_fields[0], sizeof(chain-&gt;target));</span>
<span class="lineNum">     774 </span>                :            : 
<span class="lineNum">     775 </span>                :            :     /* Pull and set Table */
<span class="lineNum">     776 </span>                :<span class="lineCov">        795 :     strlcpy(chain-&gt;table, chain_fields[1], sizeof(chain-&gt;table));</span>
<span class="lineNum">     777 </span>                :            : 
<span class="lineNum">     778 </span>                :            :     /* Pull and set From_chain */
<span class="lineNum">     779 </span>                :<span class="lineCov">        795 :     strlcpy(chain-&gt;from_chain, chain_fields[2], sizeof(chain-&gt;from_chain));</span>
<span class="lineNum">     780 </span>                :            : 
<span class="lineNum">     781 </span>                :            :     /* Pull and set Jump_rule_position */
<span class="lineNum">     782 </span>                :<span class="lineCov">        795 :     chain-&gt;jump_rule_pos = strtol_wrapper(chain_fields[3],</span>
<span class="lineNum">     783 </span>                :            :             0, RCHK_MAX_FIREWD_RULE_NUM, NO_EXIT_UPON_ERR, &amp;is_err);
<span class="lineNum">     784 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 795 times"> + </span>]:<span class="lineCov">        795 :     if(is_err != FKO_SUCCESS)</span>
<span class="lineNum">     785 </span>                :            :     {
<span class="lineNum">     786 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_ERR, &quot;[*] invalid jump rule position in Line: %s&quot;,</span>
<span class="lineNum">     787 </span>                :            :             conf_str);
<span class="lineNum">     788 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     789 </span>                :            :     }
<span class="lineNum">     790 </span>                :            : 
<span class="lineNum">     791 </span>                :            :     /* Pull and set To_chain */
<span class="lineNum">     792 </span>                :<span class="lineCov">        795 :     strlcpy(chain-&gt;to_chain, chain_fields[4], sizeof(chain-&gt;to_chain));</span>
<span class="lineNum">     793 </span>                :            : 
<span class="lineNum">     794 </span>                :            :     /* Pull and set to_chain rule position */
<span class="lineNum">     795 </span>                :<span class="lineCov">        795 :     chain-&gt;rule_pos = strtol_wrapper(chain_fields[5],</span>
<span class="lineNum">     796 </span>                :            :             0, RCHK_MAX_FIREWD_RULE_NUM, NO_EXIT_UPON_ERR, &amp;is_err);
<span class="lineNum">     797 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 795 times"> + </span>]:<span class="lineCov">        795 :     if(is_err != FKO_SUCCESS)</span>
<span class="lineNum">     798 </span>                :            :     {
<span class="lineNum">     799 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_ERR, &quot;[*] invalid to_chain rule position in Line: %s&quot;,</span>
<span class="lineNum">     800 </span>                :            :             conf_str);
<span class="lineNum">     801 </span>                :<span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     802 </span>                :            :     }
<span class="lineNum">     803 </span>                :            :     return 1;
<span class="lineNum">     804 </span>                :            : }
<a name="805"><span class="lineNum">     805 </span>                :            : </a>
<span class="lineNum">     806 </span>                :            : int
<span class="lineNum">     807 </span>                :<span class="lineCov">        795 : fw_config_init(fko_srv_options_t * const opts)</span>
<span class="lineNum">     808 </span>                :            : {
<span class="lineNum">     809 </span>                :            :     memset(&amp;fwc, 0x0, sizeof(struct fw_config));
<span class="lineNum">     810 </span>                :            : 
<span class="lineNum">     811 </span>                :            :     /* Set our firewall exe command path (firewall-cmd or iptables in most cases).
<span class="lineNum">     812 </span>                :            :     */
<span class="lineNum">     813 </span>                :            : #if FIREWALL_FIREWALLD
<span class="lineNum">     814 </span>                :            :     char cmd_passthru[512];
<span class="lineNum">     815 </span>                :<span class="lineCov">        795 :     snprintf(cmd_passthru, sizeof cmd_passthru, &quot;%s %s &quot;,</span>
<span class="lineNum">     816 </span>                :            :         opts-&gt;config[CONF_FIREWALL_EXE], FIREWD_CMD_PREFIX);
<span class="lineNum">     817 </span>                :<span class="lineCov">        795 :     strlcpy(fwc.fw_command, cmd_passthru, sizeof(fwc.fw_command));</span>
<span class="lineNum">     818 </span>                :            : #else
<span class="lineNum">     819 </span>                :            :     strlcpy(fwc.fw_command, opts-&gt;config[CONF_FIREWALL_EXE], sizeof(fwc.fw_command));
<span class="lineNum">     820 </span>                :            : #endif
<span class="lineNum">     821 </span>                :            : 
<span class="lineNum">     822 </span>                :            : #if HAVE_LIBFIU
<span class="lineNum">     823 </span>                :            :     fiu_return_on(&quot;fw_config_init&quot;, 0);
<span class="lineNum">     824 </span>                :            : #endif
<span class="lineNum">     825 </span>                :            : 
<span class="lineNum">     826 </span>                :            :     /* Pull the fwknop chain config info and setup our internal
<span class="lineNum">     827 </span>                :            :      * config struct.  The FIREWD_INPUT is the only one that is
<span class="lineNum">     828 </span>                :            :      * required. The rest are optional.
<span class="lineNum">     829 </span>                :            :     */
<span class="lineNum">     830 </span>        [<span class="branchCov" title="Branch 1 was taken 795 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        795 :     if(set_fw_chain_conf(FIREWD_INPUT_ACCESS, opts-&gt;config[CONF_FIREWD_INPUT_ACCESS]) != 1)</span>
<span class="lineNum">     831 </span>                :            :         return 0;
<span class="lineNum">     832 </span>                :            : 
<span class="lineNum">     833 </span>                :            :     /* The FWKNOP_OUTPUT_ACCESS requires ENABLE_FIREWD_OUTPUT_ACCESS == Y
<span class="lineNum">     834 </span>                :            :     */
<span class="lineNum">     835 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 795 times"> + </span>]:<span class="lineCov">        795 :     if(strncasecmp(opts-&gt;config[CONF_ENABLE_FIREWD_OUTPUT], &quot;Y&quot;, 1)==0)</span>
<span class="lineNum">     836 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(set_fw_chain_conf(FIREWD_OUTPUT_ACCESS, opts-&gt;config[CONF_FIREWD_OUTPUT_ACCESS]) != 1)</span>
<span class="lineNum">     837 </span>                :            :             return 0;
<span class="lineNum">     838 </span>                :            : 
<span class="lineNum">     839 </span>                :            :     /* The remaining access chains require ENABLE_FIREWD_FORWARDING = Y
<span class="lineNum">     840 </span>                :            :     */
<span class="lineNum">     841 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 795 times"> + </span>]:<span class="lineCov">        795 :     if(strncasecmp(opts-&gt;config[CONF_ENABLE_FIREWD_FORWARDING], &quot;Y&quot;, 1)==0)</span>
<span class="lineNum">     842 </span>                :            :     {
<span class="lineNum">     843 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(set_fw_chain_conf(FIREWD_FORWARD_ACCESS, opts-&gt;config[CONF_FIREWD_FORWARD_ACCESS]) != 1)</span>
<span class="lineNum">     844 </span>                :            :             return 0;
<span class="lineNum">     845 </span>                :            : 
<span class="lineNum">     846 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(set_fw_chain_conf(FIREWD_DNAT_ACCESS, opts-&gt;config[CONF_FIREWD_DNAT_ACCESS]) != 1)</span>
<span class="lineNum">     847 </span>                :            :             return 0;
<span class="lineNum">     848 </span>                :            : 
<span class="lineNum">     849 </span>                :            :         /* Requires ENABLE_FIREWD_SNAT = Y
<span class="lineNum">     850 </span>                :            :         */
<span class="lineNum">     851 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(strncasecmp(opts-&gt;config[CONF_ENABLE_FIREWD_SNAT], &quot;Y&quot;, 1)==0)</span>
<span class="lineNum">     852 </span>                :            :         {
<span class="lineNum">     853 </span>                :            :             /* Support both SNAT and MASQUERADE - this will be controlled
<span class="lineNum">     854 </span>                :            :              * via the access.conf configuration for individual rules
<span class="lineNum">     855 </span>                :            :             */
<span class="lineNum">     856 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(set_fw_chain_conf(FIREWD_MASQUERADE_ACCESS,</span>
<span class="lineNum">     857 </span>                :<span class="lineNoCov">          0 :                         opts-&gt;config[CONF_FIREWD_MASQUERADE_ACCESS]) != 1)</span>
<span class="lineNum">     858 </span>                :            :                 return 0;
<span class="lineNum">     859 </span>                :            : 
<span class="lineNum">     860 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(set_fw_chain_conf(FIREWD_SNAT_ACCESS,</span>
<span class="lineNum">     861 </span>                :<span class="lineNoCov">          0 :                         opts-&gt;config[CONF_FIREWD_SNAT_ACCESS]) != 1)</span>
<span class="lineNum">     862 </span>                :            :                 return 0;
<span class="lineNum">     863 </span>                :            :         }
<span class="lineNum">     864 </span>                :            :     }
<span class="lineNum">     865 </span>                :            : 
<span class="lineNum">     866 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 795 times"> + </span>]:<span class="lineCov">        795 :     if(strncasecmp(opts-&gt;config[CONF_ENABLE_DESTINATION_RULE], &quot;Y&quot;, 1)==0)</span>
<span class="lineNum">     867 </span>                :            :     {
<span class="lineNum">     868 </span>                :<span class="lineNoCov">          0 :         fwc.use_destination = 1;</span>
<span class="lineNum">     869 </span>                :            :     }
<span class="lineNum">     870 </span>                :            : 
<span class="lineNum">     871 </span>                :            :     /* Let us find it via our opts struct as well.
<span class="lineNum">     872 </span>                :            :     */
<span class="lineNum">     873 </span>                :<span class="lineCov">        795 :     opts-&gt;fw_config = &amp;fwc;</span>
<span class="lineNum">     874 </span>                :            : 
<span class="lineNum">     875 </span>                :<span class="lineCov">        795 :     return 1;</span>
<span class="lineNum">     876 </span>                :            : }
<a name="877"><span class="lineNum">     877 </span>                :            : </a>
<span class="lineNum">     878 </span>                :            : int
<span class="lineNum">     879 </span>                :<span class="lineNoCov">          0 : fw_initialize(const fko_srv_options_t * const opts)</span>
<span class="lineNum">     880 </span>                :            : {
<span class="lineNum">     881 </span>                :<span class="lineNoCov">          0 :     int res = 1;</span>
<span class="lineNum">     882 </span>                :            : 
<span class="lineNum">     883 </span>                :            :     /* Flush the chains (just in case) so we can start fresh.
<span class="lineNum">     884 </span>                :            :     */
<span class="lineNum">     885 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(strncasecmp(opts-&gt;config[CONF_FLUSH_FIREWD_AT_INIT], &quot;Y&quot;, 1) == 0)</span>
<span class="lineNum">     886 </span>                :<span class="lineNoCov">          0 :         delete_all_chains(opts);</span>
<span class="lineNum">     887 </span>                :            : 
<span class="lineNum">     888 </span>                :            :     /* Now create any configured chains.
<span class="lineNum">     889 </span>                :            :     */
<span class="lineNum">     890 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(create_fw_chains(opts) != 0)</span>
<span class="lineNum">     891 </span>                :            :     {
<span class="lineNum">     892 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_WARNING,</span>
<span class="lineNum">     893 </span>                :            :                 &quot;Warning: Errors detected during fwknop custom chain creation&quot;);
<span class="lineNum">     894 </span>                :<span class="lineNoCov">          0 :         res = 0;</span>
<span class="lineNum">     895 </span>                :            :     }
<span class="lineNum">     896 </span>                :            : 
<span class="lineNum">     897 </span>                :            :     /* Make sure that the 'comment' match is available
<span class="lineNum">     898 </span>                :            :     */
<span class="lineNum">     899 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(strncasecmp(opts-&gt;config[CONF_ENABLE_FIREWD_COMMENT_CHECK], &quot;Y&quot;, 1) == 0)</span>
<span class="lineNum">     900 </span>                :            :     {
<span class="lineNum">     901 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(comment_match_exists(opts) == 1)</span>
<span class="lineNum">     902 </span>                :            :         {
<span class="lineNum">     903 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_INFO, &quot;firewalld 'comment' match is available&quot;);</span>
<span class="lineNum">     904 </span>                :            :         }
<span class="lineNum">     905 </span>                :            :         else
<span class="lineNum">     906 </span>                :            :         {
<span class="lineNum">     907 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_WARNING, &quot;Warning: Could not use the 'comment' match&quot;);</span>
<span class="lineNum">     908 </span>                :<span class="lineNoCov">          0 :             res = 0;</span>
<span class="lineNum">     909 </span>                :            :         }
<span class="lineNum">     910 </span>                :            :     }
<span class="lineNum">     911 </span>                :            : 
<span class="lineNum">     912 </span>                :            :     /* See if firewalld offers the '-C' argument (older versions don't).  If not,
<span class="lineNum">     913 </span>                :            :      * then switch to parsing firewalld -L output to find rules.
<span class="lineNum">     914 </span>                :            :     */
<span class="lineNum">     915 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(opts-&gt;firewd_disable_check_support)</span>
<span class="lineNum">     916 </span>                :<span class="lineNoCov">          0 :         have_firewd_chk_support = 0;</span>
<span class="lineNum">     917 </span>                :            :     else
<span class="lineNum">     918 </span>                :<span class="lineNoCov">          0 :         firewd_chk_support(opts);</span>
<span class="lineNum">     919 </span>                :            : 
<span class="lineNum">     920 </span>                :<span class="lineNoCov">          0 :     return(res);</span>
<span class="lineNum">     921 </span>                :            : }
<a name="922"><span class="lineNum">     922 </span>                :            : </a>
<span class="lineNum">     923 </span>                :            : int
<span class="lineNum">     924 </span>                :<span class="lineNoCov">          0 : fw_cleanup(const fko_srv_options_t * const opts)</span>
<span class="lineNum">     925 </span>                :            : {
<span class="lineNum">     926 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(strncasecmp(opts-&gt;config[CONF_FLUSH_FIREWD_AT_EXIT], &quot;N&quot;, 1) == 0</span>
<span class="lineNum">     927 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             &amp;&amp; opts-&gt;fw_flush == 0)</span>
<span class="lineNum">     928 </span>                :            :         return(0);
<span class="lineNum">     929 </span>                :            : 
<span class="lineNum">     930 </span>                :<span class="lineNoCov">          0 :     delete_all_chains(opts);</span>
<span class="lineNum">     931 </span>                :<span class="lineNoCov">          0 :     return(0);</span>
<span class="lineNum">     932 </span>                :            : }
<a name="933"><span class="lineNum">     933 </span>                :            : </a>
<span class="lineNum">     934 </span>                :            : static int
<span class="lineNum">     935 </span>                :<span class="lineNoCov">          0 : create_rule(const fko_srv_options_t * const opts,</span>
<span class="lineNum">     936 </span>                :            :         const char * const fw_chain, const char * const fw_rule)
<span class="lineNum">     937 </span>                :            : {
<span class="lineNum">     938 </span>                :<span class="lineNoCov">          0 :     int res = 0;</span>
<span class="lineNum">     939 </span>                :            : 
<span class="lineNum">     940 </span>                :<span class="lineNoCov">          0 :     zero_cmd_buffers();</span>
<span class="lineNum">     941 </span>                :            : 
<span class="lineNum">     942 </span>                :<span class="lineNoCov">          0 :     snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s -A %s %s&quot;, opts-&gt;fw_config-&gt;fw_command, fw_chain, fw_rule);</span>
<span class="lineNum">     943 </span>                :            : 
<span class="lineNum">     944 </span>                :<span class="lineNoCov">          0 :     res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE, WANT_STDERR,</span>
<span class="lineNum">     945 </span>                :            :                 NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">     946 </span>                :<span class="lineNoCov">          0 :     chop_newline(err_buf);</span>
<span class="lineNum">     947 </span>                :            : 
<span class="lineNum">     948 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG, &quot;create_rule() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">     949 </span>                :            :         cmd_buf, res, err_buf);
<span class="lineNum">     950 </span>                :            : 
<span class="lineNum">     951 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">     952 </span>                :            :     {
<span class="lineNum">     953 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;create_rule() Rule: '%s' added to %s&quot;, fw_rule, fw_chain);</span>
<span class="lineNum">     954 </span>                :<span class="lineNoCov">          0 :         res = 1;</span>
<span class="lineNum">     955 </span>                :            :     }
<span class="lineNum">     956 </span>                :            :     else
<span class="lineNum">     957 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">     958 </span>                :            : 
<span class="lineNum">     959 </span>                :<span class="lineNoCov">          0 :     return res;</span>
<span class="lineNum">     960 </span>                :            : }
<a name="961"><span class="lineNum">     961 </span>                :            : </a>
<span class="lineNum">     962 </span>                :            : static void
<span class="lineNum">     963 </span>                :<span class="lineNoCov">          0 : firewd_rule(const fko_srv_options_t * const opts,</span>
<span class="lineNum">     964 </span>                :            :         const char * const complete_rule_buf,
<span class="lineNum">     965 </span>                :            :         const char * const fw_rule_macro,
<span class="lineNum">     966 </span>                :            :         const char * const srcip, const char * const dstip,
<span class="lineNum">     967 </span>                :            :         const unsigned int proto, const unsigned int port,
<span class="lineNum">     968 </span>                :            :         struct fw_chain * const chain,
<span class="lineNum">     969 </span>                :            :         const unsigned int exp_ts, const time_t now,
<span class="lineNum">     970 </span>                :            :         const char * const msg, const char * const access_msg)
<span class="lineNum">     971 </span>                :            : {
<span class="lineNum">     972 </span>                :<span class="lineNoCov">          0 :     char rule_buf[CMD_BUFSIZE] = {0};</span>
<span class="lineNum">     973 </span>                :            : 
<span class="lineNum">     974 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(complete_rule_buf != NULL &amp;&amp; complete_rule_buf[0] != 0x0)</span>
<span class="lineNum">     975 </span>                :            :     {
<span class="lineNum">     976 </span>                :<span class="lineNoCov">          0 :         strlcpy(rule_buf, complete_rule_buf, CMD_BUFSIZE-1);</span>
<span class="lineNum">     977 </span>                :            :     }
<span class="lineNum">     978 </span>                :            :     else
<span class="lineNum">     979 </span>                :            :     {
<span class="lineNum">     980 </span>                :            :         memset(rule_buf, 0, CMD_BUFSIZE);
<span class="lineNum">     981 </span>                :            : 
<span class="lineNum">     982 </span>                :            :         snprintf(rule_buf, CMD_BUFSIZE-1, fw_rule_macro,
<span class="lineNum">     983 </span>                :<span class="lineNoCov">          0 :             chain-&gt;table,</span>
<span class="lineNum">     984 </span>                :            :             proto,
<span class="lineNum">     985 </span>                :            :             srcip,
<span class="lineNum">     986 </span>                :            :             dstip,
<span class="lineNum">     987 </span>                :            :             port,
<span class="lineNum">     988 </span>                :            :             exp_ts,
<span class="lineNum">     989 </span>                :<span class="lineNoCov">          0 :             chain-&gt;target</span>
<span class="lineNum">     990 </span>                :            :         );
<span class="lineNum">     991 </span>                :            :     }
<span class="lineNum">     992 </span>                :            : 
<span class="lineNum">     993 </span>                :            :     /* Check to make sure that the chain and jump rule exists
<span class="lineNum">     994 </span>                :            :     */
<span class="lineNum">     995 </span>                :<span class="lineNoCov">          0 :     mk_chain(opts, chain-&gt;type);</span>
<span class="lineNum">     996 </span>                :            : 
<span class="lineNum">     997 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(rule_exists(opts, chain, rule_buf,</span>
<span class="lineNum">     998 </span>                :            :                 proto, srcip, dstip, port, exp_ts) == 0)
<span class="lineNum">     999 </span>                :            :     {
<span class="lineNum">    1000 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(create_rule(opts, chain-&gt;to_chain, rule_buf))</span>
<span class="lineNum">    1001 </span>                :            :         {
<span class="lineNum">    1002 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             log_msg(LOG_INFO, &quot;Added %s rule to %s for %s -&gt; %s %s, expires at %u&quot;,</span>
<span class="lineNum">    1003 </span>                :            :                 msg, chain-&gt;to_chain, srcip, (dstip == NULL) ? FIREWD_ANY_IP : dstip,
<span class="lineNum">    1004 </span>                :            :                 access_msg, exp_ts
<span class="lineNum">    1005 </span>                :            :             );
<span class="lineNum">    1006 </span>                :            : 
<span class="lineNum">    1007 </span>                :<span class="lineNoCov">          0 :             chain-&gt;active_rules++;</span>
<span class="lineNum">    1008 </span>                :            : 
<span class="lineNum">    1009 </span>                :            :             /* Reset the next expected expire time for this chain if it
<span class="lineNum">    1010 </span>                :            :             * is warranted.
<span class="lineNum">    1011 </span>                :            :             */
<span class="lineNum">    1012 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(chain-&gt;next_expire &lt; now || exp_ts &lt; chain-&gt;next_expire)</span>
<span class="lineNum">    1013 </span>                :<span class="lineNoCov">          0 :                 chain-&gt;next_expire = exp_ts;</span>
<span class="lineNum">    1014 </span>                :            :         }
<span class="lineNum">    1015 </span>                :            :     }
<span class="lineNum">    1016 </span>                :            : 
<span class="lineNum">    1017 </span>                :<span class="lineNoCov">          0 :     return;</span>
<a name="1018"><span class="lineNum">    1018 </span>                :            : }</a>
<span class="lineNum">    1019 </span>                :            : 
<span class="lineNum">    1020 </span>                :<span class="lineNoCov">          0 : static void forward_access_rule(const fko_srv_options_t * const opts,</span>
<span class="lineNum">    1021 </span>                :            :         const acc_stanza_t * const acc,
<span class="lineNum">    1022 </span>                :            :         struct fw_chain * const fwd_chain,
<span class="lineNum">    1023 </span>                :            :         const char * const nat_ip,
<span class="lineNum">    1024 </span>                :            :         const unsigned int nat_port,
<span class="lineNum">    1025 </span>                :            :         const unsigned int fst_proto,
<span class="lineNum">    1026 </span>                :            :         const unsigned int fst_port,
<span class="lineNum">    1027 </span>                :            :         spa_data_t * const spadat,
<span class="lineNum">    1028 </span>                :            :         const unsigned int exp_ts,
<span class="lineNum">    1029 </span>                :            :         const time_t now)
<span class="lineNum">    1030 </span>                :            : {
<span class="lineNum">    1031 </span>                :<span class="lineNoCov">          0 :     char   rule_buf[CMD_BUFSIZE] = {0};</span>
<span class="lineNum">    1032 </span>                :            : 
<span class="lineNum">    1033 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG,</span>
<span class="lineNum">    1034 </span>                :            :             &quot;forward_access_rule() forward_all: %d, nat_ip: %s, nat_port: %d&quot;,
<span class="lineNum">    1035 </span>                :<span class="lineNoCov">          0 :             acc-&gt;forward_all, nat_ip, nat_port);</span>
<span class="lineNum">    1036 </span>                :            : 
<span class="lineNum">    1037 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(acc-&gt;forward_all)</span>
<span class="lineNum">    1038 </span>                :            :     {
<span class="lineNum">    1039 </span>                :            :         memset(rule_buf, 0, CMD_BUFSIZE);
<span class="lineNum">    1040 </span>                :            : 
<span class="lineNum">    1041 </span>                :<span class="lineNoCov">          0 :         snprintf(rule_buf, CMD_BUFSIZE-1, FIREWD_FWD_ALL_RULE_ARGS,</span>
<span class="lineNum">    1042 </span>                :<span class="lineNoCov">          0 :             fwd_chain-&gt;table,</span>
<span class="lineNum">    1043 </span>                :            :             spadat-&gt;use_src_ip,
<span class="lineNum">    1044 </span>                :            :             exp_ts,
<span class="lineNum">    1045 </span>                :<span class="lineNoCov">          0 :             fwd_chain-&gt;target</span>
<span class="lineNum">    1046 </span>                :            :         );
<span class="lineNum">    1047 </span>                :            : 
<span class="lineNum">    1048 </span>                :            :         /* Make a global ACCEPT rule for all ports/protocols
<span class="lineNum">    1049 </span>                :            :         */
<span class="lineNum">    1050 </span>                :<span class="lineNoCov">          0 :         firewd_rule(opts, rule_buf, NULL, spadat-&gt;use_src_ip,</span>
<span class="lineNum">    1051 </span>                :            :             NULL, ANY_PROTO, ANY_PORT, fwd_chain, exp_ts, now,
<span class="lineNum">    1052 </span>                :            :             &quot;FORWARD ALL&quot;, &quot;*/*&quot;);
<span class="lineNum">    1053 </span>                :            :     }
<span class="lineNum">    1054 </span>                :            :     else
<span class="lineNum">    1055 </span>                :            :     {
<span class="lineNum">    1056 </span>                :            :         /* Make the FORWARD access rule
<span class="lineNum">    1057 </span>                :            :         */
<span class="lineNum">    1058 </span>                :<span class="lineNoCov">          0 :         firewd_rule(opts, NULL, FIREWD_FWD_RULE_ARGS, spadat-&gt;use_src_ip,</span>
<span class="lineNum">    1059 </span>                :            :             nat_ip, fst_proto, nat_port, fwd_chain, exp_ts, now,
<span class="lineNum">    1060 </span>                :<span class="lineNoCov">          0 :             &quot;FORWARD&quot;, spadat-&gt;spa_message_remain);</span>
<span class="lineNum">    1061 </span>                :            : 
<span class="lineNum">    1062 </span>                :            :     }
<span class="lineNum">    1063 </span>                :<span class="lineNoCov">          0 :     return;</span>
<a name="1064"><span class="lineNum">    1064 </span>                :            : }</a>
<span class="lineNum">    1065 </span>                :            : 
<span class="lineNum">    1066 </span>                :<span class="lineNoCov">          0 : static void dnat_rule(const fko_srv_options_t * const opts,</span>
<span class="lineNum">    1067 </span>                :            :         const acc_stanza_t * const acc,
<span class="lineNum">    1068 </span>                :            :         struct fw_chain * const dnat_chain,
<span class="lineNum">    1069 </span>                :            :         const char * const nat_ip,
<span class="lineNum">    1070 </span>                :            :         const unsigned int nat_port,
<span class="lineNum">    1071 </span>                :            :         const unsigned int fst_proto,
<span class="lineNum">    1072 </span>                :            :         const unsigned int fst_port,
<span class="lineNum">    1073 </span>                :            :         spa_data_t * const spadat,
<span class="lineNum">    1074 </span>                :            :         const unsigned int exp_ts,
<span class="lineNum">    1075 </span>                :            :         const time_t now)
<span class="lineNum">    1076 </span>                :            : {
<span class="lineNum">    1077 </span>                :<span class="lineNoCov">          0 :     char   rule_buf[CMD_BUFSIZE] = {0};</span>
<span class="lineNum">    1078 </span>                :            : 
<span class="lineNum">    1079 </span>                :<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG, &quot;dnat_rule() forward_all: %d, nat_ip: %s, nat_port: %d&quot;,</span>
<span class="lineNum">    1080 </span>                :<span class="lineNoCov">          0 :             acc-&gt;forward_all, nat_ip, nat_port);</span>
<span class="lineNum">    1081 </span>                :            : 
<span class="lineNum">    1082 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(acc-&gt;forward_all)</span>
<span class="lineNum">    1083 </span>                :            :     {
<span class="lineNum">    1084 </span>                :            :         memset(rule_buf, 0, CMD_BUFSIZE);
<span class="lineNum">    1085 </span>                :            : 
<span class="lineNum">    1086 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         snprintf(rule_buf, CMD_BUFSIZE-1, FIREWD_DNAT_ALL_RULE_ARGS,</span>
<span class="lineNum">    1087 </span>                :<span class="lineNoCov">          0 :             dnat_chain-&gt;table,</span>
<span class="lineNum">    1088 </span>                :            :             spadat-&gt;use_src_ip,
<span class="lineNum">    1089 </span>                :<span class="lineNoCov">          0 :             (fwc.use_destination ? spadat-&gt;pkt_destination_ip : FIREWD_ANY_IP),</span>
<span class="lineNum">    1090 </span>                :            :             exp_ts,
<span class="lineNum">    1091 </span>                :<span class="lineNoCov">          0 :             dnat_chain-&gt;target,</span>
<span class="lineNum">    1092 </span>                :            :             nat_ip
<span class="lineNum">    1093 </span>                :            :         );
<span class="lineNum">    1094 </span>                :            : 
<span class="lineNum">    1095 </span>                :            :         /* Make a global DNAT rule for all ports/protocols
<span class="lineNum">    1096 </span>                :            :         */
<span class="lineNum">    1097 </span>                :<span class="lineNoCov">          0 :         firewd_rule(opts, rule_buf, NULL, spadat-&gt;use_src_ip,</span>
<span class="lineNum">    1098 </span>                :            :             NULL, ANY_PROTO, ANY_PORT, dnat_chain, exp_ts, now,
<span class="lineNum">    1099 </span>                :            :             &quot;DNAT ALL&quot;, &quot;*/*&quot;);
<span class="lineNum">    1100 </span>                :            :     }
<span class="lineNum">    1101 </span>                :            :     else
<span class="lineNum">    1102 </span>                :            :     {
<span class="lineNum">    1103 </span>                :            :         memset(rule_buf, 0, CMD_BUFSIZE);
<span class="lineNum">    1104 </span>                :            : 
<span class="lineNum">    1105 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         snprintf(rule_buf, CMD_BUFSIZE-1, FIREWD_DNAT_RULE_ARGS,</span>
<span class="lineNum">    1106 </span>                :<span class="lineNoCov">          0 :             dnat_chain-&gt;table,</span>
<span class="lineNum">    1107 </span>                :            :             fst_proto,
<span class="lineNum">    1108 </span>                :            :             spadat-&gt;use_src_ip,
<span class="lineNum">    1109 </span>                :<span class="lineNoCov">          0 :             (fwc.use_destination ? spadat-&gt;pkt_destination_ip : FIREWD_ANY_IP),</span>
<span class="lineNum">    1110 </span>                :            :             fst_port,
<span class="lineNum">    1111 </span>                :            :             exp_ts,
<span class="lineNum">    1112 </span>                :<span class="lineNoCov">          0 :             dnat_chain-&gt;target,</span>
<span class="lineNum">    1113 </span>                :            :             nat_ip,
<span class="lineNum">    1114 </span>                :            :             nat_port
<span class="lineNum">    1115 </span>                :            :         );
<span class="lineNum">    1116 </span>                :            : 
<span class="lineNum">    1117 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         firewd_rule(opts, rule_buf, NULL, spadat-&gt;use_src_ip,</span>
<span class="lineNum">    1118 </span>                :<span class="lineNoCov">          0 :             (fwc.use_destination ? spadat-&gt;pkt_destination_ip : FIREWD_ANY_IP),</span>
<span class="lineNum">    1119 </span>                :            :             fst_proto, fst_port, dnat_chain, exp_ts, now, &quot;DNAT&quot;,
<span class="lineNum">    1120 </span>                :<span class="lineNoCov">          0 :             spadat-&gt;spa_message_remain);</span>
<span class="lineNum">    1121 </span>                :            :     }
<span class="lineNum">    1122 </span>                :<span class="lineNoCov">          0 :     return;</span>
<a name="1123"><span class="lineNum">    1123 </span>                :            : }</a>
<span class="lineNum">    1124 </span>                :            : 
<span class="lineNum">    1125 </span>                :<span class="lineNoCov">          0 : static void snat_rule(const fko_srv_options_t * const opts,</span>
<span class="lineNum">    1126 </span>                :            :         const acc_stanza_t * const acc,
<span class="lineNum">    1127 </span>                :            :         const char * const nat_ip,
<span class="lineNum">    1128 </span>                :            :         const unsigned int nat_port,
<span class="lineNum">    1129 </span>                :            :         const unsigned int fst_proto,
<span class="lineNum">    1130 </span>                :            :         const unsigned int fst_port,
<span class="lineNum">    1131 </span>                :            :         spa_data_t * const spadat,
<span class="lineNum">    1132 </span>                :            :         const unsigned int exp_ts,
<span class="lineNum">    1133 </span>                :            :         const time_t now)
<span class="lineNum">    1134 </span>                :            : {
<span class="lineNum">    1135 </span>                :<span class="lineNoCov">          0 :     char     rule_buf[CMD_BUFSIZE] = {0};</span>
<span class="lineNum">    1136 </span>                :<span class="lineNoCov">          0 :     char     snat_target[SNAT_TARGET_BUFSIZE] = {0};</span>
<span class="lineNum">    1137 </span>                :<span class="lineNoCov">          0 :     struct   fw_chain *snat_chain = NULL;</span>
<span class="lineNum">    1138 </span>                :            : 
<span class="lineNum">    1139 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     log_msg(LOG_DEBUG,</span>
<span class="lineNum">    1140 </span>                :            :             &quot;snat_rule() forward_all: %d, nat_ip: %s, nat_port: %d, force_snat: %d, force_snat_ip: %s, force_masq: %d&quot;,
<span class="lineNum">    1141 </span>                :<span class="lineNoCov">          0 :             acc-&gt;forward_all, nat_ip, nat_port, acc-&gt;force_snat,</span>
<span class="lineNum">    1142 </span>                :<span class="lineNoCov">          0 :             (acc-&gt;force_snat_ip == NULL) ? &quot;(NONE)&quot; : acc-&gt;force_snat_ip,</span>
<span class="lineNum">    1143 </span>                :<span class="lineNoCov">          0 :             acc-&gt;force_masquerade);</span>
<span class="lineNum">    1144 </span>                :            : 
<span class="lineNum">    1145 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(acc-&gt;forward_all)</span>
<span class="lineNum">    1146 </span>                :            :     {
<span class="lineNum">    1147 </span>                :            :         /* Default to MASQUERADE */
<span class="lineNum">    1148 </span>                :<span class="lineNoCov">          0 :         snat_chain = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_MASQUERADE_ACCESS]);</span>
<span class="lineNum">    1149 </span>                :            :         snprintf(snat_target, SNAT_TARGET_BUFSIZE-1, &quot; &quot;);
<span class="lineNum">    1150 </span>                :            : 
<span class="lineNum">    1151 </span>                :            :         /* Add SNAT or MASQUERADE rules.
<span class="lineNum">    1152 </span>                :            :         */
<span class="lineNum">    1153 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(acc-&gt;force_snat &amp;&amp; is_valid_ipv4_addr(acc-&gt;force_snat_ip))</span>
<span class="lineNum">    1154 </span>                :            :         {
<span class="lineNum">    1155 </span>                :            :             /* Using static SNAT */
<span class="lineNum">    1156 </span>                :<span class="lineNoCov">          0 :             snat_chain = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_SNAT_ACCESS]);</span>
<span class="lineNum">    1157 </span>                :<span class="lineNoCov">          0 :             snprintf(snat_target, SNAT_TARGET_BUFSIZE-1,</span>
<span class="lineNum">    1158 </span>                :            :                 &quot;--to-source %s&quot;, acc-&gt;force_snat_ip);
<span class="lineNum">    1159 </span>                :            :         }
<span class="lineNum">    1160 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         else if((opts-&gt;config[CONF_SNAT_TRANSLATE_IP] != NULL)</span>
<span class="lineNum">    1161 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             &amp;&amp; is_valid_ipv4_addr(opts-&gt;config[CONF_SNAT_TRANSLATE_IP]))</span>
<span class="lineNum">    1162 </span>                :            :         {
<span class="lineNum">    1163 </span>                :            :             /* Using static SNAT */
<span class="lineNum">    1164 </span>                :<span class="lineNoCov">          0 :             snat_chain = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_SNAT_ACCESS]);</span>
<span class="lineNum">    1165 </span>                :<span class="lineNoCov">          0 :             snprintf(snat_target, SNAT_TARGET_BUFSIZE-1,</span>
<span class="lineNum">    1166 </span>                :            :                 &quot;--to-source %s&quot;, opts-&gt;config[CONF_SNAT_TRANSLATE_IP]);
<span class="lineNum">    1167 </span>                :            :         }
<span class="lineNum">    1168 </span>                :            : 
<span class="lineNum">    1169 </span>                :            :         memset(rule_buf, 0, CMD_BUFSIZE);
<span class="lineNum">    1170 </span>                :            : 
<span class="lineNum">    1171 </span>                :<span class="lineNoCov">          0 :         snprintf(rule_buf, CMD_BUFSIZE-1, FIREWD_SNAT_ALL_RULE_ARGS,</span>
<span class="lineNum">    1172 </span>                :<span class="lineNoCov">          0 :             snat_chain-&gt;table,</span>
<span class="lineNum">    1173 </span>                :            :             spadat-&gt;use_src_ip,
<span class="lineNum">    1174 </span>                :            :             exp_ts,
<span class="lineNum">    1175 </span>                :<span class="lineNoCov">          0 :             snat_chain-&gt;target,</span>
<span class="lineNum">    1176 </span>                :            :             snat_target
<span class="lineNum">    1177 </span>                :            :         );
<span class="lineNum">    1178 </span>                :            : 
<span class="lineNum">    1179 </span>                :<span class="lineNoCov">          0 :         firewd_rule(opts, rule_buf, NULL, spadat-&gt;use_src_ip,</span>
<span class="lineNum">    1180 </span>                :            :             NULL, ANY_PROTO, ANY_PORT, snat_chain, exp_ts, now,
<span class="lineNum">    1181 </span>                :            :             &quot;SNAT ALL&quot;, &quot;*/*&quot;);
<span class="lineNum">    1182 </span>                :            :     }
<span class="lineNum">    1183 </span>                :            :     else
<span class="lineNum">    1184 </span>                :            :     {
<span class="lineNum">    1185 </span>                :            :         /* Add SNAT or MASQUERADE rules.
<span class="lineNum">    1186 </span>                :            :         */
<span class="lineNum">    1187 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(acc-&gt;force_snat &amp;&amp; is_valid_ipv4_addr(acc-&gt;force_snat_ip))</span>
<span class="lineNum">    1188 </span>                :            :         {
<span class="lineNum">    1189 </span>                :            :             /* Using static SNAT */
<span class="lineNum">    1190 </span>                :<span class="lineNoCov">          0 :             snat_chain = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_SNAT_ACCESS]);</span>
<span class="lineNum">    1191 </span>                :<span class="lineNoCov">          0 :             snprintf(snat_target, SNAT_TARGET_BUFSIZE-1,</span>
<span class="lineNum">    1192 </span>                :            :                 &quot;--to-source %s:%i&quot;, acc-&gt;force_snat_ip, fst_port);
<span class="lineNum">    1193 </span>                :            :         }
<span class="lineNum">    1194 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         else if(acc-&gt;force_snat &amp;&amp; acc-&gt;force_masquerade)</span>
<span class="lineNum">    1195 </span>                :            :         {
<span class="lineNum">    1196 </span>                :            :             /* Using MASQUERADE */
<span class="lineNum">    1197 </span>                :<span class="lineNoCov">          0 :             snat_chain = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_MASQUERADE_ACCESS]);</span>
<span class="lineNum">    1198 </span>                :            :             snprintf(snat_target, SNAT_TARGET_BUFSIZE-1,
<span class="lineNum">    1199 </span>                :            :                 &quot;--to-ports %i&quot;, fst_port);
<span class="lineNum">    1200 </span>                :            :         }
<span class="lineNum">    1201 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         else if((opts-&gt;config[CONF_SNAT_TRANSLATE_IP] != NULL)</span>
<span class="lineNum">    1202 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             &amp;&amp; is_valid_ipv4_addr(opts-&gt;config[CONF_SNAT_TRANSLATE_IP]))</span>
<span class="lineNum">    1203 </span>                :            :         {
<span class="lineNum">    1204 </span>                :            :             /* Using static SNAT */
<span class="lineNum">    1205 </span>                :<span class="lineNoCov">          0 :             snat_chain = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_SNAT_ACCESS]);</span>
<span class="lineNum">    1206 </span>                :<span class="lineNoCov">          0 :             snprintf(snat_target, SNAT_TARGET_BUFSIZE-1,</span>
<span class="lineNum">    1207 </span>                :            :                 &quot;--to-source %s:%i&quot;, opts-&gt;config[CONF_SNAT_TRANSLATE_IP],
<span class="lineNum">    1208 </span>                :            :                 fst_port);
<span class="lineNum">    1209 </span>                :            :         }
<span class="lineNum">    1210 </span>                :            :         else
<span class="lineNum">    1211 </span>                :            :         {
<span class="lineNum">    1212 </span>                :            :             /* Using MASQUERADE */
<span class="lineNum">    1213 </span>                :<span class="lineNoCov">          0 :             snat_chain = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_MASQUERADE_ACCESS]);</span>
<span class="lineNum">    1214 </span>                :            :             snprintf(snat_target, SNAT_TARGET_BUFSIZE-1,
<span class="lineNum">    1215 </span>                :            :                 &quot;--to-ports %i&quot;, fst_port);
<span class="lineNum">    1216 </span>                :            :         }
<span class="lineNum">    1217 </span>                :            : 
<span class="lineNum">    1218 </span>                :            :         memset(rule_buf, 0, CMD_BUFSIZE);
<span class="lineNum">    1219 </span>                :            : 
<span class="lineNum">    1220 </span>                :            :         snprintf(rule_buf, CMD_BUFSIZE-1, FIREWD_SNAT_RULE_ARGS,
<span class="lineNum">    1221 </span>                :<span class="lineNoCov">          0 :             snat_chain-&gt;table,</span>
<span class="lineNum">    1222 </span>                :            :             fst_proto,
<span class="lineNum">    1223 </span>                :            :             nat_ip,
<span class="lineNum">    1224 </span>                :            :             nat_port,
<span class="lineNum">    1225 </span>                :            :             exp_ts,
<span class="lineNum">    1226 </span>                :<span class="lineNoCov">          0 :             snat_chain-&gt;target,</span>
<span class="lineNum">    1227 </span>                :            :             snat_target
<span class="lineNum">    1228 </span>                :            :         );
<span class="lineNum">    1229 </span>                :            : 
<span class="lineNum">    1230 </span>                :<span class="lineNoCov">          0 :         firewd_rule(opts, rule_buf, NULL, spadat-&gt;use_src_ip,</span>
<span class="lineNum">    1231 </span>                :            :                 NULL, fst_proto, nat_port, snat_chain, exp_ts, now, &quot;SNAT&quot;,
<span class="lineNum">    1232 </span>                :<span class="lineNoCov">          0 :                 spadat-&gt;spa_message_remain);</span>
<span class="lineNum">    1233 </span>                :            :     }
<span class="lineNum">    1234 </span>                :<span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1235 </span>                :            : }
<span class="lineNum">    1236 </span>                :            : 
<span class="lineNum">    1237 </span>                :            : /****************************************************************************/
<span class="lineNum">    1238 </span>                :            : 
<span class="lineNum">    1239 </span>                :            : /* Rule Processing - Create an access request...
<a name="1240"><span class="lineNum">    1240 </span>                :            : */</a>
<span class="lineNum">    1241 </span>                :            : int
<span class="lineNum">    1242 </span>                :<span class="lineNoCov">          0 : process_spa_request(const fko_srv_options_t * const opts,</span>
<span class="lineNum">    1243 </span>                :            :         const acc_stanza_t * const acc, spa_data_t * const spadat)
<span class="lineNum">    1244 </span>                :            : {
<span class="lineNum">    1245 </span>                :<span class="lineNoCov">          0 :     char            nat_ip[MAX_IPV4_STR_LEN] = {0};</span>
<span class="lineNum">    1246 </span>                :<span class="lineNoCov">          0 :     unsigned int    nat_port = 0;</span>
<span class="lineNum">    1247 </span>                :            :     unsigned int    fst_proto;
<span class="lineNum">    1248 </span>                :            :     unsigned int    fst_port;
<span class="lineNum">    1249 </span>                :            : 
<span class="lineNum">    1250 </span>                :<span class="lineNoCov">          0 :     struct fw_chain * const in_chain   = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_INPUT_ACCESS]);</span>
<span class="lineNum">    1251 </span>                :<span class="lineNoCov">          0 :     struct fw_chain * const out_chain  = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_OUTPUT_ACCESS]);</span>
<span class="lineNum">    1252 </span>                :<span class="lineNoCov">          0 :     struct fw_chain * const fwd_chain  = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_FORWARD_ACCESS]);</span>
<span class="lineNum">    1253 </span>                :<span class="lineNoCov">          0 :     struct fw_chain * const dnat_chain = &amp;(opts-&gt;fw_config-&gt;chain[FIREWD_DNAT_ACCESS]);</span>
<span class="lineNum">    1254 </span>                :            : 
<span class="lineNum">    1255 </span>                :<span class="lineNoCov">          0 :     acc_port_list_t *port_list = NULL;</span>
<span class="lineNum">    1256 </span>                :<span class="lineNoCov">          0 :     acc_port_list_t *ple = NULL;</span>
<span class="lineNum">    1257 </span>                :            : 
<span class="lineNum">    1258 </span>                :<span class="lineNoCov">          0 :     char            *ndx = NULL;</span>
<span class="lineNum">    1259 </span>                :<span class="lineNoCov">          0 :     int             res = 0, is_err;</span>
<span class="lineNum">    1260 </span>                :            :     time_t          now;
<span class="lineNum">    1261 </span>                :            :     unsigned int    exp_ts;
<span class="lineNum">    1262 </span>                :            : 
<span class="lineNum">    1263 </span>                :            :     /* Parse and expand our access message.
<span class="lineNum">    1264 </span>                :            :     */
<span class="lineNum">    1265 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(expand_acc_port_list(&amp;port_list, spadat-&gt;spa_message_remain) != 1)</span>
<span class="lineNum">    1266 </span>                :            :     {
<span class="lineNum">    1267 </span>                :            :         /* technically we would already have exited with an error if there were
<span class="lineNum">    1268 </span>                :            :          * any memory allocation errors (see the add_port_list() function), but
<span class="lineNum">    1269 </span>                :            :          * for completeness...
<span class="lineNum">    1270 </span>                :            :         */
<span class="lineNum">    1271 </span>                :<span class="lineNoCov">          0 :         free_acc_port_list(port_list);</span>
<span class="lineNum">    1272 </span>                :<span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    1273 </span>                :            :     }
<span class="lineNum">    1274 </span>                :            : 
<span class="lineNum">    1275 </span>                :            :     /* Start at the top of the proto-port list...
<span class="lineNum">    1276 </span>                :            :     */
<span class="lineNum">    1277 </span>                :<span class="lineNoCov">          0 :     ple = port_list;</span>
<span class="lineNum">    1278 </span>                :            : 
<span class="lineNum">    1279 </span>                :            :     /* Remember the first proto/port combo in case we need them
<span class="lineNum">    1280 </span>                :            :      * for NAT access requests.
<span class="lineNum">    1281 </span>                :            :     */
<span class="lineNum">    1282 </span>                :<span class="lineNoCov">          0 :     fst_proto = ple-&gt;proto;</span>
<span class="lineNum">    1283 </span>                :<span class="lineNoCov">          0 :     fst_port  = ple-&gt;port;</span>
<span class="lineNum">    1284 </span>                :            : 
<span class="lineNum">    1285 </span>                :            :     /* Set our expire time value.
<span class="lineNum">    1286 </span>                :            :     */
<span class="lineNum">    1287 </span>                :<span class="lineNoCov">          0 :     time(&amp;now);</span>
<span class="lineNum">    1288 </span>                :<span class="lineNoCov">          0 :     exp_ts = now + spadat-&gt;fw_access_timeout;</span>
<span class="lineNum">    1289 </span>                :            : 
<span class="lineNum">    1290 </span>                :            :     /* deal with SPA packets that themselves request a NAT operation
<span class="lineNum">    1291 </span>                :            :     */
<span class="lineNum">    1292 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(spadat-&gt;message_type == FKO_LOCAL_NAT_ACCESS_MSG</span>
<span class="lineNum">    1293 </span>                :            :       || spadat-&gt;message_type == FKO_CLIENT_TIMEOUT_LOCAL_NAT_ACCESS_MSG
<span class="lineNum">    1294 </span>                :<span class="lineNoCov">          0 :       || spadat-&gt;message_type == FKO_NAT_ACCESS_MSG</span>
<span class="lineNum">    1295 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       || spadat-&gt;message_type == FKO_CLIENT_TIMEOUT_NAT_ACCESS_MSG</span>
<span class="lineNum">    1296 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       || acc-&gt;force_nat)</span>
<span class="lineNum">    1297 </span>                :            :     {
<span class="lineNum">    1298 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(acc-&gt;force_nat)</span>
<span class="lineNum">    1299 </span>                :            :         {
<span class="lineNum">    1300 </span>                :<span class="lineNoCov">          0 :             strlcpy(nat_ip, acc-&gt;force_nat_ip, sizeof(nat_ip));</span>
<span class="lineNum">    1301 </span>                :<span class="lineNoCov">          0 :             nat_port = acc-&gt;force_nat_port;</span>
<span class="lineNum">    1302 </span>                :            :         }
<span class="lineNum">    1303 </span>                :            :         else
<span class="lineNum">    1304 </span>                :            :         {
<span class="lineNum">    1305 </span>                :<span class="lineNoCov">          0 :             ndx = strchr(spadat-&gt;nat_access, ',');</span>
<span class="lineNum">    1306 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(ndx != NULL)</span>
<span class="lineNum">    1307 </span>                :            :             {
<span class="lineNum">    1308 </span>                :<span class="lineNoCov">          0 :                 strlcpy(nat_ip, spadat-&gt;nat_access, (ndx-spadat-&gt;nat_access)+1);</span>
<span class="lineNum">    1309 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (! is_valid_ipv4_addr(nat_ip))</span>
<span class="lineNum">    1310 </span>                :            :                 {
<span class="lineNum">    1311 </span>                :<span class="lineNoCov">          0 :                     log_msg(LOG_INFO, &quot;Invalid NAT IP in SPA message&quot;);</span>
<span class="lineNum">    1312 </span>                :<span class="lineNoCov">          0 :                     free_acc_port_list(port_list);</span>
<span class="lineNum">    1313 </span>                :<span class="lineNoCov">          0 :                     return res;</span>
<span class="lineNum">    1314 </span>                :            :                 }
<span class="lineNum">    1315 </span>                :            : 
<span class="lineNum">    1316 </span>                :<span class="lineNoCov">          0 :                 nat_port = strtol_wrapper(ndx+1, 0, MAX_PORT,</span>
<span class="lineNum">    1317 </span>                :            :                         NO_EXIT_UPON_ERR, &amp;is_err);
<span class="lineNum">    1318 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(is_err != FKO_SUCCESS)</span>
<span class="lineNum">    1319 </span>                :            :                 {
<span class="lineNum">    1320 </span>                :<span class="lineNoCov">          0 :                     log_msg(LOG_INFO, &quot;Invalid NAT port in SPA message&quot;);</span>
<span class="lineNum">    1321 </span>                :<span class="lineNoCov">          0 :                     free_acc_port_list(port_list);</span>
<span class="lineNum">    1322 </span>                :<span class="lineNoCov">          0 :                     res = is_err;</span>
<span class="lineNum">    1323 </span>                :<span class="lineNoCov">          0 :                     return res;</span>
<span class="lineNum">    1324 </span>                :            :                 }
<span class="lineNum">    1325 </span>                :            :             }
<span class="lineNum">    1326 </span>                :            :         }
<span class="lineNum">    1327 </span>                :            : 
<span class="lineNum">    1328 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(spadat-&gt;message_type == FKO_LOCAL_NAT_ACCESS_MSG)</span>
<span class="lineNum">    1329 </span>                :            :         {
<span class="lineNum">    1330 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             firewd_rule(opts, NULL, FIREWD_RULE_ARGS, spadat-&gt;use_src_ip,</span>
<span class="lineNum">    1331 </span>                :<span class="lineNoCov">          0 :                 (fwc.use_destination ? spadat-&gt;pkt_destination_ip : FIREWD_ANY_IP),</span>
<span class="lineNum">    1332 </span>                :            :                 fst_proto, nat_port, in_chain, exp_ts, now, &quot;local NAT&quot;,
<span class="lineNum">    1333 </span>                :            :                 spadat-&gt;spa_message_remain);
<span class="lineNum">    1334 </span>                :            :         }
<span class="lineNum">    1335 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         else if(strlen(fwd_chain-&gt;to_chain))</span>
<span class="lineNum">    1336 </span>                :            :         {
<span class="lineNum">    1337 </span>                :            :             /* FORWARD access rule
<span class="lineNum">    1338 </span>                :            :             */
<span class="lineNum">    1339 </span>                :<span class="lineNoCov">          0 :             forward_access_rule(opts, acc, fwd_chain, nat_ip,</span>
<span class="lineNum">    1340 </span>                :            :                     nat_port, fst_proto, fst_port, spadat, exp_ts, now);
<span class="lineNum">    1341 </span>                :            :         }
<span class="lineNum">    1342 </span>                :            : 
<span class="lineNum">    1343 </span>                :            :         /* DNAT rule
<span class="lineNum">    1344 </span>                :            :         */
<span class="lineNum">    1345 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(strlen(dnat_chain-&gt;to_chain) &amp;&amp; !acc-&gt;disable_dnat)</span>
<span class="lineNum">    1346 </span>                :<span class="lineNoCov">          0 :             dnat_rule(opts, acc, dnat_chain, nat_ip,</span>
<span class="lineNum">    1347 </span>                :            :                     nat_port, fst_proto, fst_port, spadat, exp_ts, now);
<span class="lineNum">    1348 </span>                :            : 
<span class="lineNum">    1349 </span>                :            :         /* SNAT rule
<span class="lineNum">    1350 </span>                :            :         */
<span class="lineNum">    1351 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(acc-&gt;force_snat || strncasecmp(opts-&gt;config[CONF_ENABLE_FIREWD_SNAT], &quot;Y&quot;, 1) == 0)</span>
<span class="lineNum">    1352 </span>                :<span class="lineNoCov">          0 :             snat_rule(opts, acc, nat_ip, nat_port,</span>
<span class="lineNum">    1353 </span>                :            :                     fst_proto, fst_port, spadat, exp_ts, now);
<span class="lineNum">    1354 </span>                :            :     }
<span class="lineNum">    1355 </span>                :            :     else /* Non-NAT request - this is the typical case. */
<span class="lineNum">    1356 </span>                :            :     {
<span class="lineNum">    1357 </span>                :            :         /* Create an access command for each proto/port for the source ip.
<span class="lineNum">    1358 </span>                :            :         */
<span class="lineNum">    1359 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while(ple != NULL)</span>
<span class="lineNum">    1360 </span>                :            :         {
<span class="lineNum">    1361 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             firewd_rule(opts, NULL, FIREWD_RULE_ARGS, spadat-&gt;use_src_ip,</span>
<span class="lineNum">    1362 </span>                :<span class="lineNoCov">          0 :                 (fwc.use_destination ? spadat-&gt;pkt_destination_ip : FIREWD_ANY_IP),</span>
<span class="lineNum">    1363 </span>                :            :                 ple-&gt;proto, ple-&gt;port, in_chain, exp_ts, now, &quot;access&quot;,
<span class="lineNum">    1364 </span>                :            :                 spadat-&gt;spa_message_remain);
<span class="lineNum">    1365 </span>                :            : 
<span class="lineNum">    1366 </span>                :            :             /* We need to make a corresponding OUTPUT rule if out_chain target
<span class="lineNum">    1367 </span>                :            :              * is not NULL.
<span class="lineNum">    1368 </span>                :            :             */
<span class="lineNum">    1369 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(strlen(out_chain-&gt;to_chain))</span>
<span class="lineNum">    1370 </span>                :            :             {
<span class="lineNum">    1371 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 firewd_rule(opts, NULL, FIREWD_OUT_RULE_ARGS, spadat-&gt;use_src_ip,</span>
<span class="lineNum">    1372 </span>                :<span class="lineNoCov">          0 :                     (fwc.use_destination ? spadat-&gt;pkt_destination_ip : FIREWD_ANY_IP),</span>
<span class="lineNum">    1373 </span>                :            :                     ple-&gt;proto, ple-&gt;port, out_chain, exp_ts, now, &quot;OUTPUT&quot;,
<span class="lineNum">    1374 </span>                :            :                     spadat-&gt;spa_message_remain);
<span class="lineNum">    1375 </span>                :            :             }
<span class="lineNum">    1376 </span>                :<span class="lineNoCov">          0 :             ple = ple-&gt;next;</span>
<span class="lineNum">    1377 </span>                :            :         }
<span class="lineNum">    1378 </span>                :            :     }
<span class="lineNum">    1379 </span>                :            : 
<span class="lineNum">    1380 </span>                :            :     /* Done with the port list for access rules.
<span class="lineNum">    1381 </span>                :            :     */
<span class="lineNum">    1382 </span>                :<span class="lineNoCov">          0 :     free_acc_port_list(port_list);</span>
<span class="lineNum">    1383 </span>                :            : 
<span class="lineNum">    1384 </span>                :<span class="lineNoCov">          0 :     return(res);</span>
<span class="lineNum">    1385 </span>                :            : }
<span class="lineNum">    1386 </span>                :            : 
<span class="lineNum">    1387 </span>                :            : /* Iterate over the configure firewall access chains and purge expired
<span class="lineNum">    1388 </span>                :            :  * firewall rules.
<a name="1389"><span class="lineNum">    1389 </span>                :            : */</a>
<span class="lineNum">    1390 </span>                :            : void
<span class="lineNum">    1391 </span>                :<span class="lineNoCov">          0 : check_firewall_rules(const fko_srv_options_t * const opts)</span>
<span class="lineNum">    1392 </span>                :            : {
<span class="lineNum">    1393 </span>                :<span class="lineNoCov">          0 :     char             exp_str[12]     = {0};</span>
<span class="lineNum">    1394 </span>                :<span class="lineNoCov">          0 :     char             rule_num_str[6] = {0};</span>
<span class="lineNum">    1395 </span>                :            :     char            *ndx, *rn_start, *rn_end, *tmp_mark;
<span class="lineNum">    1396 </span>                :            : 
<span class="lineNum">    1397 </span>                :            :     int             i, res, rn_offset, rule_num, is_err;
<span class="lineNum">    1398 </span>                :<span class="lineNoCov">          0 :     time_t          now, rule_exp, min_exp = 0;</span>
<span class="lineNum">    1399 </span>                :            : 
<span class="lineNum">    1400 </span>                :<span class="lineNoCov">          0 :     struct fw_chain *ch = opts-&gt;fw_config-&gt;chain;</span>
<span class="lineNum">    1401 </span>                :            : 
<span class="lineNum">    1402 </span>                :<span class="lineNoCov">          0 :     time(&amp;now);</span>
<span class="lineNum">    1403 </span>                :            : 
<span class="lineNum">    1404 </span>                :            :     /* Iterate over each chain and look for active rules to delete.
<span class="lineNum">    1405 </span>                :            :     */
<span class="lineNum">    1406 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for(i=0; i &lt; NUM_FWKNOP_ACCESS_TYPES; i++)</span>
<span class="lineNum">    1407 </span>                :            :     {
<span class="lineNum">    1408 </span>                :            :         /* If there are no active rules or we have not yet
<span class="lineNum">    1409 </span>                :            :          * reached our expected next expire time, continue.
<span class="lineNum">    1410 </span>                :            :         */
<span class="lineNum">    1411 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(ch[i].active_rules == 0 || ch[i].next_expire &gt; now)</span>
<span class="lineNum">    1412 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    1413 </span>                :            : 
<span class="lineNum">    1414 </span>                :<span class="lineNoCov">          0 :         zero_cmd_buffers();</span>
<span class="lineNum">    1415 </span>                :            : 
<span class="lineNum">    1416 </span>                :<span class="lineNoCov">          0 :         rn_offset = 0;</span>
<span class="lineNum">    1417 </span>                :            : 
<span class="lineNum">    1418 </span>                :            :         /* There should be a rule to delete.  Get the current list of
<span class="lineNum">    1419 </span>                :            :          * rules for this chain and delete the ones that are expired.
<span class="lineNum">    1420 </span>                :            :         */
<span class="lineNum">    1421 </span>                :            :         snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_LIST_RULES_ARGS,
<span class="lineNum">    1422 </span>                :<span class="lineNoCov">          0 :             opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">    1423 </span>                :<span class="lineNoCov">          0 :             ch[i].table,</span>
<span class="lineNum">    1424 </span>                :<span class="lineNoCov">          0 :             ch[i].to_chain</span>
<span class="lineNum">    1425 </span>                :            :         );
<span class="lineNum">    1426 </span>                :            : 
<span class="lineNum">    1427 </span>                :<span class="lineNoCov">          0 :         res = run_extcmd(cmd_buf, cmd_out, STANDARD_CMD_OUT_BUFSIZE,</span>
<span class="lineNum">    1428 </span>                :            :                 WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">    1429 </span>                :<span class="lineNoCov">          0 :         chop_newline(cmd_out);</span>
<span class="lineNum">    1430 </span>                :            : 
<span class="lineNum">    1431 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;check_firewall_rules() CMD: '%s' (res: %d, cmd_out: %s)&quot;,</span>
<span class="lineNum">    1432 </span>                :            :             cmd_buf, res, cmd_out);
<span class="lineNum">    1433 </span>                :            : 
<span class="lineNum">    1434 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(!EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">    1435 </span>                :            :         {
<span class="lineNum">    1436 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, cmd_out);</span>
<span class="lineNum">    1437 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    1438 </span>                :            :         }
<span class="lineNum">    1439 </span>                :            : 
<span class="lineNum">    1440 </span>                :<span class="lineNoCov">          0 :         log_msg(LOG_DEBUG, &quot;RES=%i, CMD_BUF: %s\nRULES LIST: %s&quot;, res, cmd_buf, cmd_out);</span>
<span class="lineNum">    1441 </span>                :            : 
<span class="lineNum">    1442 </span>                :<span class="lineNoCov">          0 :         ndx = strstr(cmd_out, EXPIRE_COMMENT_PREFIX);</span>
<span class="lineNum">    1443 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(ndx == NULL)</span>
<span class="lineNum">    1444 </span>                :            :         {
<span class="lineNum">    1445 </span>                :            :             /* we did not find an expected rule.
<span class="lineNum">    1446 </span>                :            :             */
<span class="lineNum">    1447 </span>                :<span class="lineNoCov">          0 :             log_msg(LOG_ERR,</span>
<span class="lineNum">    1448 </span>                :            :                 &quot;Did not find expire comment in rules list %i&quot;, i);
<span class="lineNum">    1449 </span>                :            : 
<span class="lineNum">    1450 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if (ch[i].active_rules &gt; 0)</span>
<span class="lineNum">    1451 </span>                :<span class="lineNoCov">          0 :                 ch[i].active_rules--;</span>
<span class="lineNum">    1452 </span>                :            : 
<span class="lineNum">    1453 </span>                :<span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    1454 </span>                :            :         }
<span class="lineNum">    1455 </span>                :            : 
<span class="lineNum">    1456 </span>                :            :         /* walk the list and process rules as needed.
<span class="lineNum">    1457 </span>                :            :         */
<span class="lineNum">    1458 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while (ndx != NULL) {</span>
<span class="lineNum">    1459 </span>                :            :             /* Jump forward and extract the timestamp
<span class="lineNum">    1460 </span>                :            :             */
<span class="lineNum">    1461 </span>                :<span class="lineNoCov">          0 :             ndx += strlen(EXPIRE_COMMENT_PREFIX);</span>
<span class="lineNum">    1462 </span>                :            : 
<span class="lineNum">    1463 </span>                :            :             /* remember this spot for when we look for the next
<span class="lineNum">    1464 </span>                :            :              * rule.
<span class="lineNum">    1465 </span>                :            :             */
<span class="lineNum">    1466 </span>                :<span class="lineNoCov">          0 :             tmp_mark = ndx;</span>
<span class="lineNum">    1467 </span>                :            : 
<span class="lineNum">    1468 </span>                :<span class="lineNoCov">          0 :             strlcpy(exp_str, ndx, sizeof(exp_str));</span>
<span class="lineNum">    1469 </span>                :<span class="lineNoCov">          0 :             rule_exp = (time_t)atoll(exp_str);</span>
<span class="lineNum">    1470 </span>                :            : 
<span class="lineNum">    1471 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             if(rule_exp &lt;= now)</span>
<span class="lineNum">    1472 </span>                :            :             {
<span class="lineNum">    1473 </span>                :            :                 /* Backtrack and get the rule number and delete it.
<span class="lineNum">    1474 </span>                :            :                 */
<span class="lineNum">    1475 </span>                :            :                 rn_start = ndx;
<span class="lineNum">    1476 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 while(--rn_start &gt; cmd_out)</span>
<span class="lineNum">    1477 </span>                :            :                 {
<span class="lineNum">    1478 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if(*rn_start == '\n')</span>
<span class="lineNum">    1479 </span>                :            :                         break;
<span class="lineNum">    1480 </span>                :            :                 }
<span class="lineNum">    1481 </span>                :            : 
<span class="lineNum">    1482 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(*rn_start != '\n')</span>
<span class="lineNum">    1483 </span>                :            :                 {
<span class="lineNum">    1484 </span>                :            :                     /* This should not happen. But if it does, complain,
<span class="lineNum">    1485 </span>                :            :                      * decrement the active rule value, and go on.
<span class="lineNum">    1486 </span>                :            :                     */
<span class="lineNum">    1487 </span>                :<span class="lineNoCov">          0 :                     log_msg(LOG_ERR,</span>
<span class="lineNum">    1488 </span>                :            :                         &quot;Rule parse error while finding rule line start in chain %i&quot;, i);
<span class="lineNum">    1489 </span>                :            : 
<span class="lineNum">    1490 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (ch[i].active_rules &gt; 0)</span>
<span class="lineNum">    1491 </span>                :<span class="lineNoCov">          0 :                         ch[i].active_rules--;</span>
<span class="lineNum">    1492 </span>                :            : 
<span class="lineNum">    1493 </span>                :            :                     break;
<span class="lineNum">    1494 </span>                :            :                 }
<span class="lineNum">    1495 </span>                :<span class="lineNoCov">          0 :                 rn_start++;</span>
<span class="lineNum">    1496 </span>                :            : 
<span class="lineNum">    1497 </span>                :<span class="lineNoCov">          0 :                 rn_end = strchr(rn_start, ' ');</span>
<span class="lineNum">    1498 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(rn_end == NULL)</span>
<span class="lineNum">    1499 </span>                :            :                 {
<span class="lineNum">    1500 </span>                :            :                     /* This should not happen. But if it does, complain,
<span class="lineNum">    1501 </span>                :            :                      * decrement the active rule value, and go on.
<span class="lineNum">    1502 </span>                :            :                     */
<span class="lineNum">    1503 </span>                :<span class="lineNoCov">          0 :                     log_msg(LOG_ERR,</span>
<span class="lineNum">    1504 </span>                :            :                         &quot;Rule parse error while finding rule number in chain %i&quot;, i);
<span class="lineNum">    1505 </span>                :            : 
<span class="lineNum">    1506 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (ch[i].active_rules &gt; 0)</span>
<span class="lineNum">    1507 </span>                :<span class="lineNoCov">          0 :                         ch[i].active_rules--;</span>
<span class="lineNum">    1508 </span>                :            : 
<span class="lineNum">    1509 </span>                :            :                     break;
<span class="lineNum">    1510 </span>                :            :                 }
<span class="lineNum">    1511 </span>                :            : 
<span class="lineNum">    1512 </span>                :<span class="lineNoCov">          0 :                 strlcpy(rule_num_str, rn_start, (rn_end - rn_start)+1);</span>
<span class="lineNum">    1513 </span>                :            : 
<span class="lineNum">    1514 </span>                :<span class="lineNoCov">          0 :                 rule_num = strtol_wrapper(rule_num_str, rn_offset, RCHK_MAX_FIREWD_RULE_NUM,</span>
<span class="lineNum">    1515 </span>                :            :                         NO_EXIT_UPON_ERR, &amp;is_err);
<span class="lineNum">    1516 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(is_err != FKO_SUCCESS)</span>
<span class="lineNum">    1517 </span>                :            :                 {
<span class="lineNum">    1518 </span>                :<span class="lineNoCov">          0 :                     log_msg(LOG_ERR,</span>
<span class="lineNum">    1519 </span>                :            :                         &quot;Rule parse error while finding rule number in chain %i&quot;, i);
<span class="lineNum">    1520 </span>                :            : 
<span class="lineNum">    1521 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (ch[i].active_rules &gt; 0)</span>
<span class="lineNum">    1522 </span>                :<span class="lineNoCov">          0 :                         ch[i].active_rules--;</span>
<span class="lineNum">    1523 </span>                :            : 
<span class="lineNum">    1524 </span>                :            :                     break;
<span class="lineNum">    1525 </span>                :            :                 }
<span class="lineNum">    1526 </span>                :            : 
<span class="lineNum">    1527 </span>                :<span class="lineNoCov">          0 :                 zero_cmd_buffers();</span>
<span class="lineNum">    1528 </span>                :            : 
<span class="lineNum">    1529 </span>                :<span class="lineNoCov">          0 :                 snprintf(cmd_buf, CMD_BUFSIZE-1, &quot;%s &quot; FIREWD_DEL_RULE_ARGS,</span>
<span class="lineNum">    1530 </span>                :<span class="lineNoCov">          0 :                     opts-&gt;fw_config-&gt;fw_command,</span>
<span class="lineNum">    1531 </span>                :            :                     ch[i].table,
<span class="lineNum">    1532 </span>                :            :                     ch[i].to_chain,
<span class="lineNum">    1533 </span>                :            :                     rule_num - rn_offset
<span class="lineNum">    1534 </span>                :            :                 );
<span class="lineNum">    1535 </span>                :            : 
<span class="lineNum">    1536 </span>                :<span class="lineNoCov">          0 :                 res = run_extcmd(cmd_buf, err_buf, CMD_BUFSIZE,</span>
<span class="lineNum">    1537 </span>                :            :                         WANT_STDERR, NO_TIMEOUT, &amp;pid_status, opts);
<span class="lineNum">    1538 </span>                :<span class="lineNoCov">          0 :                 chop_newline(err_buf);</span>
<span class="lineNum">    1539 </span>                :            : 
<span class="lineNum">    1540 </span>                :<span class="lineNoCov">          0 :                 log_msg(LOG_DEBUG, &quot;check_firewall_rules() CMD: '%s' (res: %d, err: %s)&quot;,</span>
<span class="lineNum">    1541 </span>                :            :                     cmd_buf, res, err_buf);
<span class="lineNum">    1542 </span>                :            : 
<span class="lineNum">    1543 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(EXTCMD_IS_SUCCESS(res))</span>
<span class="lineNum">    1544 </span>                :            :                 {
<span class="lineNum">    1545 </span>                :<span class="lineNoCov">          0 :                     log_msg(LOG_INFO, &quot;Removed rule %s from %s with expire time of %u&quot;,</span>
<span class="lineNum">    1546 </span>                :            :                         rule_num_str, ch[i].to_chain, rule_exp
<span class="lineNum">    1547 </span>                :            :                     );
<span class="lineNum">    1548 </span>                :            : 
<span class="lineNum">    1549 </span>                :<span class="lineNoCov">          0 :                     rn_offset++;</span>
<span class="lineNum">    1550 </span>                :            : 
<span class="lineNum">    1551 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     if (ch[i].active_rules &gt; 0)</span>
<span class="lineNum">    1552 </span>                :<span class="lineNoCov">          0 :                         ch[i].active_rules--;</span>
<span class="lineNum">    1553 </span>                :            :                 }
<span class="lineNum">    1554 </span>                :            :                 else
<span class="lineNum">    1555 </span>                :<span class="lineNoCov">          0 :                     log_msg(LOG_ERR, &quot;Error %i from cmd:'%s': %s&quot;, res, cmd_buf, err_buf);</span>
<span class="lineNum">    1556 </span>                :            : 
<span class="lineNum">    1557 </span>                :            :             }
<span class="lineNum">    1558 </span>                :            :             else
<span class="lineNum">    1559 </span>                :            :             {
<span class="lineNum">    1560 </span>                :            :                 /* Track the minimum future rule expire time.
<span class="lineNum">    1561 </span>                :            :                 */
<span class="lineNum">    1562 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(rule_exp &gt; now)</span>
<span class="lineNum">    1563 </span>                :<span class="lineNoCov">          0 :                     min_exp = (min_exp &lt; rule_exp) ? min_exp : rule_exp;</span>
<span class="lineNum">    1564 </span>                :            :             }
<span class="lineNum">    1565 </span>                :            : 
<span class="lineNum">    1566 </span>                :            :             /* Push our tracking index forward beyond (just processed) _exp_
<span class="lineNum">    1567 </span>                :            :              * string so we can continue to the next rule in the list.
<span class="lineNum">    1568 </span>                :            :             */
<span class="lineNum">    1569 </span>                :<span class="lineNoCov">          0 :             ndx = strstr(tmp_mark, EXPIRE_COMMENT_PREFIX);</span>
<span class="lineNum">    1570 </span>                :            :         }
<span class="lineNum">    1571 </span>                :            : 
<span class="lineNum">    1572 </span>                :            :         /* Set the next pending expire time accordingly. 0 if there are no
<span class="lineNum">    1573 </span>                :            :          * more rules, or whatever the next expected (min_exp) time will be.
<span class="lineNum">    1574 </span>                :            :         */
<span class="lineNum">    1575 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(ch[i].active_rules &lt; 1)</span>
<span class="lineNum">    1576 </span>                :<span class="lineNoCov">          0 :             ch[i].next_expire = 0;</span>
<span class="lineNum">    1577 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         else if(min_exp)</span>
<span class="lineNum">    1578 </span>                :<span class="lineNoCov">          0 :             ch[i].next_expire = min_exp;</span>
<span class="lineNum">    1579 </span>                :            :     }
<span class="lineNum">    1580 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="1581"><span class="lineNum">    1581 </span>                :            : </a>
<span class="lineNum">    1582 </span>                :            : int
<span class="lineNum">    1583 </span>                :<span class="lineCov">       4770 : validate_firewd_chain_conf(const char * const chain_str)</span>
<span class="lineNum">    1584 </span>                :            : {
<span class="lineNum">    1585 </span>                :<span class="lineCov">       4770 :     int         j, rv  = 1;</span>
<span class="lineNum">    1586 </span>                :<span class="lineCov">       4770 :     const char   *ndx  = chain_str;</span>
<span class="lineNum">    1587 </span>                :            : 
<span class="lineNum">    1588 </span>                :<span class="lineCov">       4770 :     j = 1;</span>
<span class="lineNum">    1589 </span>        [<span class="branchCov" title="Branch 0 was taken 219420 times"> + </span><span class="branchCov" title="Branch 1 was taken 4770 times"> + </span>]:<span class="lineCov">     224190 :     while(*ndx != '\0')</span>
<span class="lineNum">    1590 </span>                :            :     {
<span class="lineNum">    1591 </span>        [<span class="branchCov" title="Branch 0 was taken 23850 times"> + </span><span class="branchCov" title="Branch 1 was taken 195570 times"> + </span>]:<span class="lineCov">     219420 :         if(*ndx == ',')</span>
<span class="lineNum">    1592 </span>                :<span class="lineCov">      23850 :             j++;</span>
<span class="lineNum">    1593 </span>                :            : 
<span class="lineNum">    1594 </span>        [<span class="branchCov" title="Branch 0 was taken 195570 times"> + </span><span class="branchCov" title="Branch 1 was taken 23850 times"> + </span>]:<span class="lineCov">     219420 :         if(*ndx != '\0'</span>
<span class="lineNum">    1595 </span>                :<span class="lineCov">     219420 :                 &amp;&amp; *ndx != ' '</span>
<span class="lineNum">    1596 </span>        [<span class="branchCov" title="Branch 0 was taken 171720 times"> + </span><span class="branchCov" title="Branch 1 was taken 23850 times"> + </span>]:<span class="lineCov">     195570 :                 &amp;&amp; *ndx != ','</span>
<span class="lineNum">    1597 </span>        [<span class="branchCov" title="Branch 0 was taken 166950 times"> + </span><span class="branchCov" title="Branch 1 was taken 4770 times"> + </span>]:<span class="lineCov">     171720 :                 &amp;&amp; *ndx != '_'</span>
<span class="lineNum">    1598 </span>        [<span class="branchCov" title="Branch 1 was taken 166950 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">     166950 :                 &amp;&amp; isalnum(*ndx) == 0)</span>
<span class="lineNum">    1599 </span>                :            :         {
<span class="lineNum">    1600 </span>                :            :             rv = 0;
<span class="lineNum">    1601 </span>                :            :             break;
<span class="lineNum">    1602 </span>                :            :         }
<span class="lineNum">    1603 </span>                :<span class="lineCov">     219420 :         ndx++;</span>
<span class="lineNum">    1604 </span>                :            :     }
<span class="lineNum">    1605 </span>                :            : 
<span class="lineNum">    1606 </span>                :            :     /* Sanity check - j should be the number of chain fields
<span class="lineNum">    1607 </span>                :            :      * (excluding the type).
<span class="lineNum">    1608 </span>                :            :     */
<span class="lineNum">    1609 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4770 times"> + </span>]:<span class="lineCov">       4770 :     if(j != FW_NUM_CHAIN_FIELDS)</span>
<span class="lineNum">    1610 </span>                :<span class="lineNoCov">          0 :         rv = 0;</span>
<span class="lineNum">    1611 </span>                :            : 
<span class="lineNum">    1612 </span>                :<span class="lineCov">       4770 :     return rv;</span>
<span class="lineNum">    1613 </span>                :            : }
<span class="lineNum">    1614 </span>                :            : 
<span class="lineNum">    1615 </span>                :            : #endif /* FIREWALL_FIREWALLD */
<span class="lineNum">    1616 </span>                :            : 
<span class="lineNum">    1617 </span>                :            : /***EOF***/
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
